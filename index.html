<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Calcolatore Longevità — v2 (by Stephan Winckler)</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#38bdf8; --accent2:#22c55e; --danger:#ef4444; --warn:#f59e0b; --ok:#10b981;
    --b:#1f2937; --card:#0b1424;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0; height:100%; background:#0e1426; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{
    position:sticky; top:0; z-index:30;
    background:rgba(12,18,34,.9); backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid var(--b);
  }
  .h-wrap{max-width:1100px; margin:0 auto; padding:10px 16px env(safe-area-inset-top) 16px}
  h1{margin:4px 0 8px; font-size:clamp(18px,4vw,24px)}
  .muted{color:var(--muted)}
  .progress{height:8px; width:100%; background:#0a1222; border:1px solid var(--b); border-radius:999px; overflow:hidden}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#60a5fa,var(--accent2)); transition:width .3s}

  .container{max-width:1100px; margin:10px auto 96px; padding:0 12px}
  .panel{
    background:linear-gradient(180deg,#0e172d, #0b1220); border:1px solid var(--b);
    border-radius:14px; padding:14px; margin:10px 0; box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03)
  }
  .section-title{margin:0 0 8px; font-size:16px; color:#c7d2fe}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .col{flex:1 1 240px; min-width:210px}
  label{display:block; font-size:13px; color:var(--muted); margin:6px 0}
  input, select, textarea{
    width:100%; padding:11px 12px; border-radius:12px; background:#0a1222; border:1px solid var(--b); color:var(--text);
    font-size:16px; /* mobile-friendly */ outline:none
  }
  input:focus, select:focus, textarea:focus{border-color:var(--accent)}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; background:linear-gradient(180deg,#0ea5e9,#0284c7); border:1px solid #0369a1; color:#fff; font-weight:600}
  .btn.secondary{background:#101826}
  .btn.ghost{background:transparent; border:1px dashed #334155; color:#cbd5e1}
  .btn.small{padding:8px 10px; font-size:13px; border-radius:10px}
  .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:10px}
  .card{background:var(--card); border:1px solid var(--b); border-radius:12px; padding:12px}
  .badge,.pill,.chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--b); font-size:12px}
  .pill{background:#0b1a2e; color:#a5b4fc}
  .chip{background:#0b1a2e}
  .mini{font-size:12px; color:#9ca3af}
  .helper{font-size:12px; color:#9ca3af; margin-top:6px}
  .table{width:100%; border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--b); padding:8px; text-align:left; font-size:14px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}

  /* Mobile footer controls */
  .foot-nav{
    position:fixed; left:0; right:0; bottom:0; z-index:40;
    background:rgba(8,12,24,.95); border-top:1px solid var(--b);
    padding:8px 12px calc(8px + env(safe-area-inset-bottom));
    display:flex; gap:8px
  }
  .foot-nav .btn{flex:1 1 50%}
  footer.legal{
    margin:20px auto; max-width:1100px; color:var(--muted); font-size:12px; padding:0 12px 80px; /* padding for foot-nav overlap */
  }

  /* Reduce top density on very small screens */
  @media (max-width:480px){
    .h-wrap{padding:8px 12px env(safe-area-inset-top) 12px}
    .container{margin-top:6px}
  }
</style>
</head>
<body>
  <header>
    <div class="h-wrap">
      <h1>Calcolatore di Longevità <span class="muted">— stima ludica & motivazionale</span></h1>
      <div class="progress"><div id="bar" class="bar"></div></div>
    </div>
  </header>

  <div class="container" id="app">

    <!-- STEP 1: ANAGRAFICA + AMBIENTE + TRASFERIMENTO -->
    <section class="panel step-panel" data-step="1">
      <h2 class="section-title">1) Dati anagrafici</h2>
      <div class="row">
        <div class="col"><label>Nome e cognome</label><input id="nome" placeholder="Es. Mario Rossi"></div>
        <div class="col"><label>Data di nascita</label><input id="dob" type="date"></div>
        <div class="col">
          <label>Sesso</label>
          <select id="sesso"><option value="nd">Preferisco non dirlo</option><option value="M">Maschio</option><option value="F">Femmina</option><option value="altro">Altro</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col"><label>Residenza attuale (Paese)</label><select id="residenza"></select></div>
        <div class="col">
          <label>Ambiente</label>
          <select id="ambiente"><option value="citta">Città</option><option value="mare">Mare</option><option value="montagna">Montagna</option><option value="campagna">Campagna</option></select>
        </div>
        <div class="col">
          <label>Pianifichi trasferimento futuro?</label>
          <select id="trasferFuturo"><option value="no">No</option><option value="si">Sì</option></select>
        </div>
      </div>
      <div id="futuroBox" class="row" style="display:none">
        <div class="col"><label>Paese di trasferimento (ipotetico)</label><select id="paeseFuturo"></select></div>
        <div class="col"><label>Anno previsto (indicativo)</label><input id="annoFuturo" type="number" min="2025" max="2100" placeholder="Es. 2030"></div>
      </div>
    </section>

    <!-- STEP 2: PAESI VISSUTI -->
    <section class="panel step-panel" data-step="2" hidden>
      <h2 class="section-title">2) Dove hai vissuto (timeline)</h2>
      <div class="row">
        <div class="col"><label>Paese</label><select id="paeseTimeline"></select></div>
        <div class="col"><label>Dal (anno)</label><input id="dalAnno" type="number" min="1900" max="2100"></div>
        <div class="col"><label>Al (anno)</label><input id="alAnno" type="number" min="1900" max="2100"></div>
        <div class="col" style="min-width:160px"><label>&nbsp;</label><button id="addTimeline" class="btn">Aggiungi</button></div>
      </div>
      <div id="timelineList" class="cards"></div>
    </section>

    <!-- STEP 3: STILE DI VITA, BMI, FUMO, ALCOL, ZUCCHERATE -->
    <section class="panel step-panel" data-step="3" hidden>
      <h2 class="section-title">3) Stile di vita</h2>
      <div class="row">
        <div class="col"><label>Attività fisica (giorni/settimana)</label><input id="sportGiorni" type="number" min="0" max="7" placeholder="0–7"></div>
        <div class="col"><label>Passi medi al giorno</label><input id="passi" type="number" min="0" step="100" placeholder="Es. 8000"></div>
        <div class="col"><label>Ore di sonno/notte</label><input id="sonno" type="number" min="0" max="14" step="0.5" placeholder="Es. 7.5"></div>
      </div>
      <div class="row">
        <div class="col"><label>Dieta</label>
          <select id="dieta">
            <option value="sana">Sana (verdura, legumi, pesce, pochi ultraprocessati)</option>
            <option value="mista">Mista/variabile</option>
            <option value="scorretta">Scorretta (fast food/ultraprocessati frequenti)</option>
          </select>
        </div>
        <div class="col"><label>Idratazione</label>
          <select id="idratazione"><option value="acqua">Prevalentemente acqua</option><option value="mista">Acqua + bevande zuccherate</option><option value="zuccherate">Quasi solo bevande zuccherate</option></select>
        </div>
        <div class="col"><label>Alcol</label>
          <select id="alcol"><option value="no">Raramente/mai</option><option value="moderato">Moderato</option><option value="alto">Alto</option></select>
        </div>
      </div>

      <hr>
      <h3 class="section-title">Fumo</h3>
      <div class="row">
        <div class="col"><label>Fumi tabacco?</label>
          <select id="fumoTab"><option value="no">No</option><option value="sigarette">Sigarette</option><option value="sigari">Sigari</option><option value="pipa">Pipa</option></select>
        </div>
        <div class="col"><label>Sigarette/die (se applicabile)</label><input id="sigDie" type="number" min="0" max="60"></div>
        <div class="col"><label>Anni di fumo</label><input id="anniFumo" type="number" min="0" max="80"></div>
      </div>
      <div class="row">
        <div class="col"><label>Usi sigaretta elettronica (svapo)?</label>
          <select id="svapo"><option value="no">No</option><option value="siNic">Sì, con nicotina</option><option value="siNoNic">Sì, senza nicotina</option></select>
        </div>
        <div class="col"><label>Frequenza svapo (tiri/giorno approx)</label><input id="svapoFreq" type="number" min="0" max="1000"></div>
      </div>

      <hr>
      <h3 class="section-title">BMI (presente e passato)</h3>
      <div class="row">
        <div class="col"><label>Altezza attuale (cm)</label><input id="hNow" type="number" min="100" max="240" placeholder="170"></div>
        <div class="col"><label>Peso attuale (kg)</label><input id="wNow" type="number" min="30" max="300" step="0.1" placeholder="80.0"></div>
        <div class="col" style="min-width:180px"><label>&nbsp;</label><button class="btn" id="calcBMI">Calcola BMI</button></div>
      </div>
      <div id="bmiNowOut" class="helper"></div>
      <div class="card" style="margin-top:8px">
        <div class="mini">BMI passati (facoltativo)</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Data</label><input id="pastDate" type="date"></div>
          <div class="col"><label>Altezza (cm)</label><input id="pastH" type="number" min="100" max="240"></div>
          <div class="col"><label>Peso (kg)</label><input id="pastW" type="number" min="30" max="300" step="0.1"></div>
          <div class="col" style="min-width:160px"><label>&nbsp;</label><button class="btn ghost" id="addPastBMI">Aggiungi BMI passato</button></div>
        </div>
        <div id="pastBMIList" class="cards" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- STEP 4: LAVORO + REDDITO + PASTI -->
    <section class="panel step-panel" data-step="4" hidden>
      <h2 class="section-title">4) Lavoro, reddito & pasti</h2>
      <div class="row">
        <div class="col">
          <label>Lavoro principale</label>
          <select id="lavoroTipo"></select>
        </div>
        <div class="col">
          <label>Ritmo dei pasti al lavoro</label>
          <select id="pasto"><option value="calma">Con calma</option><option value="fretta">Di fretta</option></select>
        </div>
        <div class="col">
          <label>Fascia di reddito annuo</label>
          <select id="reddito">
            <option value="basso">&lt; €15k</option>
            <option value="medio-basso">€15k–€30k</option>
            <option value="medio">€30k–€60k</option>
            <option value="alto">€60k–€120k</option>
            <option value="molto-alto">&gt; €120k</option>
          </select>
        </div>
      </div>
      <div class="helper">Il lavoro incide per esposizioni (polveri, solventi, rumore, turni, vibrazioni), il reddito come proxy di accesso a cura/prevenzione e stress finanziario.</div>
    </section>

    <!-- STEP 5: INCIDENTI + MALATTIE -->
    <section class="panel step-panel" data-step="5" hidden>
      <h2 class="section-title">5) Incidenti & Patologie</h2>
      <div class="card">
        <div class="mini"><strong>Incidenti avuti</strong> — seleziona evento e severità, aggiungi tutti i rilevanti.</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Tipo incidente</label><select id="incTipo"></select></div>
          <div class="col"><label>Severità</label><select id="incSev"></select></div>
          <div class="col"><label>Anno (facolt.)</label><input id="incAnno" type="number" min="1900" max="2100"></div>
          <div class="col" style="min-width:160px"><label>&nbsp;</label><button class="btn" id="addInc">Aggiungi incidente</button></div>
        </div>
        <div id="incList" class="cards" style="margin-top:6px"></div>
      </div>

      <hr>

      <div class="card">
        <div class="mini"><strong>Patologie</strong> — parte del corpo → categoria → dettaglio (come v1, database ampliato).</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Parte del corpo</label><select id="bodyPart"></select></div>
          <div class="col"><label>Categoria</label><select id="diseaseCat"></select></div>
          <div class="col"><label>Dettaglio</label><select id="diseaseDetail"></select></div>
          <div class="col" style="min-width:160px"><label>&nbsp;</label><button id="addDisease" class="btn">Aggiungi patologia</button></div>
        </div>
        <div id="diseaseList" class="cards" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- STEP 6: SESSO FEMMINILE (PARTI) + STRESS + DROGHE -->
    <section class="panel step-panel" data-step="6" hidden>
      <h2 class="section-title">6) Fattori aggiuntivi</h2>
      <div class="card" id="femaleBox" style="display:none">
        <div class="mini"><strong>Gravidanze/Parti (solo se donna)</strong></div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Numero di parti</label><input id="numParti" type="number" min="0" max="20" value="0"></div>
          <div class="col">
            <label>Tipologia prevalente</label>
            <select id="tipoParto"><option value="nessuno">Nessuno</option><option value="naturale">Naturale</option><option value="cesareo">Cesareo</option></select>
          </div>
          <div class="col">
            <label>Complicazioni significative?</label>
            <select id="compParto"><option value="no">No</option><option value="lievi">Lievi</option><option value="gravi">Gravi</option></select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="mini"><strong>Stress</strong> — autovalutazione & fattori.</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Stress percepito (0–10)</label><input id="stress" type="number" min="0" max="10" value="3"></div>
          <div class="col">
            <label>Trigger principali</label>
            <select id="stressTrig" multiple size="4" style="height:100px">
              <option>Debiti/pressione finanziaria</option>
              <option>Turni/notte</option>
              <option>Caregiver (familiari)</option>
              <option>Precarietà lavorativa</option>
              <option>Traffico/pendolarismo</option>
              <option>Isolamento sociale</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="mini"><strong>Droghe</strong> — <span class="ok">Questi dati non vengono salvati da nessuna parte</span>: servono solo per calcolare un punteggio aggregato locale sul tuo dispositivo.</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Uso di droghe?</label>
            <select id="drogheUso"><option value="no">No</option><option value="si">Sì</option></select>
          </div>
          <div class="col"><label>Tipo</label><select id="drogaTipo"></select></div>
          <div class="col"><label>Frequenza</label>
            <select id="drogaFreq">
              <option>Occasionale (&lt;1/mese)</option>
              <option>Mensile</option>
              <option>Settimanale</option>
              <option>Giornaliera</option>
            </select>
          </div>
          <div class="col" style="min-width:160px"><label>&nbsp;</label><button class="btn" id="addDroga">Aggiungi</button></div>
        </div>
        <div id="drogaList" class="cards" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- STEP 7: RIEPILOGO + CALCOLO -->
    <section class="panel step-panel" data-step="7" hidden>
      <h2 class="section-title">7) Riepilogo</h2>
      <div id="summaryCards" class="cards"></div>
      <div class="helper">Controlla i dati. Se qualcosa non torna, torna indietro e correggi. Poi avvia il calcolo.</div>
      <div class="row" style="margin-top:8px"><button class="btn" id="doCalc">Avvia calcolo</button></div>
    </section>

    <!-- STEP 8: RISULTATO -->
    <section class="panel step-panel" data-step="8" hidden>
      <h2 class="section-title">Risultato & Probabilità traguardi</h2>
      <div id="resultHead" style="font-size:clamp(22px,5vw,34px); font-weight:800"></div>
      <p id="resultDate" class="muted"></p>
      <div class="row">
        <div class="col card"><div class="mini">Età stimata (media)</div><div id="etaStimata" style="font-size:22px; margin-top:6px">–</div></div>
        <div class="col card"><div class="mini">Indice salute (–100 → +100)</div><div id="saluteScore" style="font-size:22px; margin-top:6px">–</div></div>
      </div>
      <div class="card" style="margin-top:8px">
        <table class="table"><thead><tr><th>Traguardo</th><th>Probabilità</th></tr></thead><tbody id="milestones"></tbody></table>
      </div>
      <div class="card" style="margin-top:8px">
        <div class="mini"><strong>Fattori principali che hanno inciso</strong></div>
        <ul id="drivers" class="list" style="margin-top:6px"></ul>
      </div>
      <div class="card" style="margin-top:8px">
        <div class="mini"><strong>Consigli personalizzati</strong></div>
        <ul id="tips" class="list" style="margin-top:6px"></ul>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="ricomincia">Ricomincia</button>
      </div>
    </section>
  </div>

  <!-- Mobile nav -->
  <div class="foot-nav">
    <button class="btn secondary" id="backBtn">Indietro</button>
    <button class="btn" id="nextBtn">Avanti</button>
  </div>

  <footer class="legal">
    Creata da <strong>Stephan Winckler</strong> per divertimento. Non è un consiglio medico: prendetela con leggerezza,
    ma usatela per darvi una regolata e migliorare le abitudini verso traguardi più lontani. © <span id="year"></span>
  </footer>

<script>
/* ===== Dataset: Aspettative di vita (indicativo) ===== */
const LIFE_EXP = {
 "Italia":83,"San Marino":84,"Spagna":83,"Francia":82,"Svizzera":84,"Germania":81,"Austria":82,"Regno Unito":81,
 "Irlanda":82,"Islanda":83,"Norvegia":83,"Svezia":82,"Finlandia":82,"Paesi Bassi":82,"Belgio":82,"Danimarca":81,
 "Portogallo":81,"Grecia":81,"USA":77,"Canada":82,"Messico":75,"Brasile":76,"Argentina":77,"Cile":79,"Colombia":77,
 "Perù":77,"Uruguay":78,"Giappone":84,"Corea del Sud":83,"Cina":78,"India":70,"Pakistan":67,"Bangladesh":73,
 "Sri Lanka":77,"Nepal":71,"Emirati Arabi Uniti":79,"Arabia Saudita":76,"Qatar":81,"Israele":83,"Turchia":78,
 "Marocco":75,"Tunisia":74,"Egitto":70,"Sudafrica":64,"Etiopia":67,"Kenya":66,"Nigeria":55,
 "Russia":71,"Ucraina":70,"Polonia":78,"Repubblica Ceca":79,"Slovacchia":77,"Ungheria":76,"Romania":75,
 "Bulgaria":74,"Croazia":78,"Slovenia":81,"Serbia":75,"Bosnia":75,"Albania":76,"Macedonia del Nord":75,
 "Lituania":76,"Lettonia":75,"Estonia":78,"Australia":83,"Nuova Zelanda":82
};
const COUNTRIES = Object.keys(LIFE_EXP).sort((a,b)=>a.localeCompare(b,'it'));

/* ===== Lavori e fattori di rischio (anni +/- cumulativi) ===== */
const JOBS = {
  "Ufficio/Impiegato sedentario": {years:-0.5, notes:["Sedentarietà"], expo:{sedent:true}},
  "IT/Programmatore": {years:-0.5, notes:["Sedentarietà/occhi"], expo:{sedent:true}},
  "Sanità (turni)": {years:-1.2, notes:["Turni/notte","stress"], expo:{night:true}},
  "Ristorazione (sala/cucina)": {years:-0.8, notes:["Turni","stress","calore"], expo:{heat:true}},
  "Autista/Trasporti": {years:-1.0, notes:["Seduto a lungo","turni"], expo:{sedent:true,night:true}},
  "Agricoltura": {years:-0.8, notes:["Polveri/pesticidi","sforzo"], expo:{dust:true,chem:true,phys:true}},
  "Edilizia": {years:-1.5, notes:["Polveri","rumore","cadute"], expo:{dust:true,noise:true,phys:true}},
  "Miniera/Cava": {years:-3.0, notes:["Silice","profondità"], expo:{silica:true,dust:true}},
  "Metalmeccanica/Officina": {years:-1.2, notes:["Rumore","solventi","vibrazioni"], expo:{noise:true,chem:true,vib:true}},
  "Carrozziere/Verniciatura": {years:-1.8, notes:["Solventi/vernici"], expo:{chem:true}},
  "Chimico/Industria chimica": {years:-1.6, notes:["Solventi"], expo:{chem:true}},
  "Polizia/VVF/Forze armate": {years:-1.0, notes:["Stress","rischio"], expo:{stress:true}},
  "Logistica/Magazzino pesante": {years:-1.0, notes:["Sforzo","vibrazioni"], expo:{phys:true,vib:true}},
  "Subacqueo/Alta quota": {years:-1.4, notes:["Pressione/altitudine"], expo:{pressure:true}},
  "Insegnante": {years:-0.2, notes:["Stress moderato"], expo:{stress:true}},
  "Commercio/Negozio": {years:-0.2, notes:["In piedi"], expo:{phys:true}}
};

/* ===== Malattie (ampliato; punteggi negativi) ===== */
const DISEASES = {
 "Cardio-vascolare":{
   "Ipertensione":{"Lieve":-4,"Moderata":-8,"Grave":-12},
   "Cardiopatia ischemica":{"Stabile":-10,"Recente evento":-18,"Insufficienza cardiaca":-22},
   "Aritmie":{"Benigne":-3,"Con terapia":-6,"Complesse":-10}
 },
 "Metabolico":{
   "Diabete":{"Tipo 2 ben controllato":-6,"Tipo 2 non controllato":-14,"Tipo 1":-10},
   "Dislipidemia":{"Lieve":-3,"Importante":-7},
   "Tiroide":{"Ipotiroidismo controllato":-2,"Ipertiroidismo":-4}
 },
 "Respiratorio":{
   "Asma":{"Lieve":-2,"Moderata":-5,"Grave":-9},
   "BPCO":{"Stadio iniziale":-8,"Avanzata":-16},
   "Apnea notturna":{"Lieve":-3,"Moderata":-6,"Grave":-9}
 },
 "Neurologico":{
   "Epilessia":{"Ben controllata":-3,"Non controllata":-10},
   "Ictus pregresso":{"Lieve esiti":-12,"Esiti importanti":-20},
   "Parkinson":{"Iniziale":-8,"Avanzato":-15},
   "Demenza":{"Iniziale":-10,"Avanzata":-18}
 },
 "Oncologico":{
   "Neoplasia":{"In remissione":-8,"In trattamento":-18,"Metastatica":-28}
 },
 "Rene/Fegato":{
   "Insufficienza renale":{"Lieve":-6,"Moderata":-12,"Grave":-20},
   "Epatopatia":{"Steatosi":-4,"Fibrosi/Cirrosi":-14},
   "Epatite cronica":{"Controllata":-4,"Attiva":-8}
 },
 "Muscolo-scheletrico":{
   "Obesità":{"Classe I":-6,"Classe II":-10,"Classe III":-16},
   "Sarcopenia":{"Moderata":-6,"Importante":-12},
   "Osteoporosi":{"Moderata":-4,"Grave":-7}
 },
 "Psiche":{
   "Depressione":{"Lieve":-3,"Moderata":-6,"Grave":-10},
   "Disturbi d'ansia":{"Lieve":-2,"Moderati":-4,"Gravi":-7},
   "Dipendenze":{"Alcol":-10,"Sostanze":-12}
 }
};

/* ===== Incidenti (punteggi negativi) ===== */
const INCIDENTS = {
  "Stradale": {"Lieve":-2,"Moderato":-5,"Grave":-10,"Trauma cranico":-12},
  "Sportivo": {"Lieve":-1,"Moderato":-3,"Grave":-6},
  "Infortunio sul lavoro": {"Lieve":-2,"Moderato":-6,"Grave":-10},
  "Caduta": {"Lieve":-1,"Moderata":-3,"Grave":-7},
  "Ustione": {"Lieve":-2,"Moderata":-4,"Grave":-8},
  "Intossicazione/Esposizione": {"Lieve":-2,"Moderata":-5,"Grave":-9}
};

/* ===== Droghe (punteggi) ===== */
const DRUGS = {
  "Cannabis":{"Occasionale (&lt;1/mese)":-1,"Mensile":-2,"Settimanale":-3,"Giornaliera":-5},
  "Cocaina":{"Occasionale (&lt;1/mese)":-4,"Mensile":-6,"Settimanale":-10,"Giornaliera":-15},
  "Eroina/oppioidi":{"Occasionale (&lt;1/mese)":-8,"Mensile":-12,"Settimanale":-18,"Giornaliera":-28},
  "Amfetamine":{"Occasionale (&lt;1/mese)":-4,"Mensile":-6,"Settimanale":-10,"Giornaliera":-14},
  "Allucinogeni":{"Occasionale (&lt;1/mese)":-1,"Mensile":-2,"Settimanale":-3,"Giornaliera":-6},
  "Benzodiazepine non prescritte":{"Occasionale (&lt;1/mese)":-3,"Mensile":-5,"Settimanale":-8,"Giornaliera":-12}
};

/* ===== Stato ===== */
const S = {
  step:1, timeline:[], pastBMI:[], diseases:[], incidents:[], drugs:[], inferred:[]
};

const el = s=>document.querySelector(s);
const els = s=>document.querySelectorAll(s);

/* ===== Init selects ===== */
function fillCountry(sel){ sel.innerHTML = COUNTRIES.map(c=>`<option>${c}</option>`).join(''); }
["residenza","paeseFuturo","paeseTimeline"].forEach(id=>fillCountry(el("#"+id)));

function fillJobs(){
  const sel = el("#lavoroTipo");
  sel.innerHTML = Object.keys(JOBS).map(j=>`<option>${j}</option>`).join('');
}
fillJobs();

function initDiseaseSelectors(){
  const partSel = el("#bodyPart");
  partSel.innerHTML = Object.keys(DISEASES).map(p=>`<option>${p}</option>`).join('');
  refreshDiseaseCats();
}
function refreshDiseaseCats(){
  const part = el("#bodyPart").value;
  const cats = Object.keys(DISEASES[part]||{});
  el("#diseaseCat").innerHTML = cats.map(c=>`<option>${c}</option>`).join('');
  refreshDiseaseDetails();
}
function refreshDiseaseDetails(){
  const part = el("#bodyPart").value;
  const cat = el("#diseaseCat").value;
  const dets = DISEASES?.[part]?.[cat]||{};
  el("#diseaseDetail").innerHTML = Object.keys(dets).map(d=>`<option>${d}</option>`).join('');
}
initDiseaseSelectors();
el("#bodyPart").addEventListener("change",refreshDiseaseCats);
el("#diseaseCat").addEventListener("change",refreshDiseaseDetails);

function initIncidents(){
  const tSel = el("#incTipo");
  tSel.innerHTML = Object.keys(INCIDENTS).map(k=>`<option>${k}</option>`).join('');
  refreshIncSev();
}
function refreshIncSev(){
  const t = el("#incTipo").value;
  const sev = INCIDENTS[t]||{};
  el("#incSev").innerHTML = Object.keys(sev).map(s=>`<option>${s}</option>`).join('');
}
initIncidents();
el("#incTipo").addEventListener("change",refreshIncSev);

function initDrugs(){
  const dSel = el("#drogaTipo");
  dSel.innerHTML = Object.keys(DRUGS).map(k=>`<option>${k}</option>`).join('');
}
initDrugs();

/* ===== UI helpers ===== */
function showStep(n){
  S.step=n;
  els(".step-panel").forEach(p=>p.hidden=true);
  document.querySelector(`.step-panel[data-step="${n}"]`).hidden=false;
  const pct = ((n-1)/(8-1))*100;
  el("#bar").style.width = pct+"%";
  // se donna, mostra box parti allo step 6
  const isF = el("#sesso").value==="F";
  el("#femaleBox").style.display = isF ? "" : "none";
  // summary autogenerato a step 7
  if(n===7) buildSummary();
}
function next(){ if(S.step<8) showStep(S.step+1); }
function back(){ if(S.step>1) showStep(S.step-1); }
el("#nextBtn").addEventListener("click", next);
el("#backBtn").addEventListener("click", back);

/* ===== Interazioni ===== */
el("#trasferFuturo").addEventListener("change", e=>{
  el("#futuroBox").style.display = e.target.value==="si" ? "" : "none";
});
document.addEventListener("keydown",(e)=>{ if(e.key==="Enter") next(); });

/* Timeline */
el("#addTimeline").addEventListener("click", ()=>{
  const paese=el("#paeseTimeline").value, dal=+el("#dalAnno").value, al=+el("#alAnno").value;
  if(!paese||!dal||!al||al<dal){ alert("Controlla gli anni."); return; }
  S.timeline.push({paese, dal, al});
  renderTimeline();
});
function renderTimeline(){
  const box=el("#timelineList");
  if(S.timeline.length===0){ box.innerHTML=`<div class="card muted">Nessun periodo inserito.</div>`; return; }
  box.innerHTML=S.timeline.map((t,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span class="pill">${t.paese}</span></div>
        <button class="btn ghost small" onclick="rmTL(${i})">Rimuovi</button>
      </div>
      <div class="mini">Dal <strong>${t.dal}</strong> al <strong>${t.al}</strong> — anni: <strong>${t.al - t.dal + 1}</strong> — LE ${LIFE_EXP[t.paese]||"n/d"}</div>
    </div>`).join('');
}
window.rmTL=(i)=>{ S.timeline.splice(i,1); renderTimeline(); };

/* BMI */
el("#calcBMI").addEventListener("click", ()=>{
  const h=+el("#hNow").value, w=+el("#wNow").value;
  if(!h||!w){ alert("Inserisci altezza e peso."); return; }
  const bmi=(w/Math.pow(h/100,2)).toFixed(1);
  const cls = bmi<18.5?"Sottopeso":bmi<25?"Normopeso":bmi<30?"Sovrappeso":"Obesità";
  el("#bmiNowOut").innerHTML=`BMI: <strong>${bmi}</strong> (${cls})`;
});
el("#addPastBMI").addEventListener("click", ()=>{
  const d=el("#pastDate").value, h=+el("#pastH").value, w=+el("#pastW").value;
  if(!d||!h||!w){ alert("Compila data, altezza e peso."); return; }
  const bmi=+(w/Math.pow(h/100,2)).toFixed(1);
  S.pastBMI.push({data:d,h,w,bmi}); renderPastBMI();
  el("#pastDate").value=""; el("#pastH").value=""; el("#pastW").value="";
});
function renderPastBMI(){
  const box=el("#pastBMIList");
  if(S.pastBMI.length===0){ box.innerHTML=""; return; }
  box.innerHTML=S.pastBMI.map((p,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="pill">${p.data}</div>
        <button class="btn ghost small" onclick="rmPBMI(${i})">Rimuovi</button>
      </div>
      <div class="mini">H: <strong>${p.h} cm</strong> • W: <strong>${p.w} kg</strong> • BMI: <strong>${p.bmi}</strong></div>
    </div>`).join('');
}
window.rmPBMI=(i)=>{ S.pastBMI.splice(i,1); renderPastBMI(); };

/* Incidenti */
el("#addInc").addEventListener("click", ()=>{
  const tipo=el("#incTipo").value, sev=el("#incSev").value, anno=el("#incAnno").value||null;
  const score=(INCIDENTS?.[tipo]?.[sev])||0;
  S.incidents.push({tipo,sev,anno,score});
  renderInc();
});
function renderInc(){
  const box=el("#incList");
  if(S.incidents.length===0){ box.innerHTML=`<div class="card muted">Nessun incidente inserito.</div>`; return; }
  box.innerHTML=S.incidents.map((x,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span class="pill">${x.tipo}</span> <span class="chip">${x.sev}</span> ${x.anno?`<span class="mini">(${x.anno})</span>`:""}</div>
        <div class="${x.score<0?'danger':'ok'}"><strong>${x.score}</strong> pts</div>
      </div>
      <button class="btn ghost small" style="margin-top:6px" onclick="rmInc(${i})">Rimuovi</button>
    </div>`).join('');
}
window.rmInc=(i)=>{ S.incidents.splice(i,1); renderInc(); };

/* Patologie */
el("#addDisease").addEventListener("click", ()=>{
  const part=el("#bodyPart").value, cat=el("#diseaseCat").value, det=el("#diseaseDetail").value;
  const score=DISEASES?.[part]?.[cat]?.[det]??0;
  S.diseases.push({part,cat,det,score});
  renderDiseases();
});
function renderDiseases(){
  const box=el("#diseaseList");
  if(S.diseases.length===0){ box.innerHTML = `<div class="card muted">Nessuna patologia inserita.</div>`; return; }
  box.innerHTML=S.diseases.map((d,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
        <div>
          <span class="badge">${d.part}</span>
          <span class="chip">${d.cat}</span>
          <span class="chip">${d.det}</span>
        </div>
        <div class="${d.score<0?'danger':'ok'}"><strong>${d.score}</strong> pts</div>
      </div>
      <button class="btn ghost small" style="margin-top:6px" onclick="rmDis(${i})">Rimuovi</button>
    </div>`).join('');
}
window.rmDis=(i)=>{ S.diseases.splice(i,1); renderDiseases(); };

/* Droghe */
el("#drogheUso").addEventListener("change", e=>{
  const on = e.target.value==="si";
  el("#drogaTipo").disabled = !on;
  el("#drogaFreq").disabled = !on;
});
el("#addDroga").addEventListener("click", ()=>{
  if(el("#drogheUso").value!=="si") return;
  const t=el("#drogaTipo").value, f=el("#drogaFreq").value;
  const score = DRUGS?.[t]?.[f] ?? 0;
  S.drugs.push({tipo:t,freq:f,score});
  renderDrugs();
});
function renderDrugs(){
  const box=el("#drogaList");
  if(S.drugs.length===0){ box.innerHTML=`<div class="card muted">Nessun uso dichiarato.</div>`; return; }
  box.innerHTML=S.drugs.map((d,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span class="pill">${d.tipo}</span> <span class="chip">${d.freq}</span></div>
        <div class="danger"><strong>${d.score}</strong> pts</div>
      </div>
      <button class="btn ghost small" style="margin-top:6px" onclick="rmDrug(${i})">Rimuovi</button>
    </div>`).join('');
}
window.rmDrug=(i)=>{ S.drugs.splice(i,1); renderDrugs(); };

/* Step nav Fix per mobile footer overlap */
function scrollTopPanel(){ document.querySelector(`.step-panel[data-step="${S.step}"]`)?.scrollIntoView({behavior:"smooth",block:"start"}); }
["#nextBtn","#backBtn"].forEach(sel=>el(sel).addEventListener("click",scrollTopPanel));

/* ===== Summary ===== */
function buildSummary(){
  S.inferred = [];
  const cards = [];

  // Anagrafica
  const nome = el("#nome").value?.trim()||"(senza nome)";
  const dob = el("#dob").value;
  const sesso = el("#sesso").value;
  const res = el("#residenza").value;
  const ambiente = el("#ambiente").value;
  const trasfer = el("#trasferFuturo").value==="si";
  const paeseF = el("#paeseFuturo").value;
  const annoF = +el("#annoFuturo").value||null;
  if(!dob){ S.inferred.push("Data di nascita non inserita: userò età 40 anni di default."); }

  // Timeline
  const tl = S.timeline.slice().sort((a,b)=>a.dal-b.dal);

  // Stile di vita
  const sportG = +el("#sportGiorni").value||0;
  const passi = +el("#passi").value||0;
  const sonno = +el("#sonno").value||0;
  const dieta = el("#dieta").value;
  const idr = el("#idratazione").value;
  const alcol = el("#alcol").value;
  const fumoTab = el("#fumoTab").value;
  const sigDie = +el("#sigDie").value||0;
  const anniFumo = +el("#anniFumo").value||0;
  const svapo = el("#svapo").value;
  const svFreq = +el("#svapoFreq").value||0;

  // Lavoro/Reddito/Pasti
  const lavoroTipo = el("#lavoroTipo").value;
  const pasto = el("#pasto").value;
  const reddito = el("#reddito").value;

  // Donna/parti
  const isF = sesso==="F";
  const numParti = +el("#numParti").value||0;
  const tipoParto = el("#tipoParto").value;
  const compParto = el("#compParto").value;

  // Stress e droghe
  const stress = +el("#stress").value||0;
  const stressTrig = Array.from(el("#stressTrig").selectedOptions).map(o=>o.value);

  // BMI
  const hNow=+el("#hNow").value||0, wNow=+el("#wNow").value||0;
  const bmiNow = hNow&&wNow ? +(wNow/Math.pow(hNow/100,2)).toFixed(1) : null;

  /* Cards */
  cards.push(`
    <div class="card">
      <div class="mini"><strong>Anagrafica</strong></div>
      <ul class="list">
        <li>Nome: <strong>${nome}</strong> • Data di nascita: <strong>${dob||"n/d"}</strong> • Sesso: <strong>${sesso}</strong></li>
        <li>Residenza: <strong>${res}</strong> • Ambiente: <strong>${ambiente}</strong></li>
        <li>Trasferimento futuro: <strong>${trasfer?("Sì → "+paeseF+" nel "+(annoF||"n/d")):"No"}</strong></li>
      </ul>
    </div>`);

  const tlRows = tl.map(t=>`<tr><td>${t.paese}</td><td>${t.dal}</td><td>${t.al}</td><td>${t.al - t.dal + 1}</td><td>${LIFE_EXP[t.paese]||"n/d"}</td></tr>`).join('');
  cards.push(`
    <div class="card">
      <div class="mini"><strong>Timeline Paesi</strong></div>
      <table class="table"><thead><tr><th>Paese</th><th>Dal</th><th>Al</th><th>Anni</th><th>LE</th></tr></thead><tbody>${tlRows||`<tr><td colspan="5" class="muted">Nessun periodo</td></tr>`}</tbody></table>
    </div>`);

  cards.push(`
    <div class="card">
      <div class="mini"><strong>Stile di vita</strong></div>
      <ul class="list">
        <li>Sport: <strong>${sportG}</strong> gg/settimana • Passi: <strong>${passi}</strong>/die • Sonno: <strong>${sonno}</strong> h</li>
        <li>Dieta: <strong>${dieta}</strong> • Idratazione: <strong>${idr}</strong> • Alcol: <strong>${alcol}</strong></li>
        <li>Fumo: <strong>${fumoTab}</strong> ${sigDie?`• ${sigDie} cig/die`:''} ${anniFumo?`• ${anniFumo} anni`:''} • Svapo: <strong>${svapo}</strong> ${svFreq?`(${svFreq}/g)`:''}</li>
        <li>BMI: <strong>${bmiNow??"n/d"}</strong></li>
      </ul>
      ${S.pastBMI.length?`<div class="mini" style="margin-top:4px">BMI passati: ${S.pastBMI.map(p=>`${p.data}→${p.bmi}`).join(", ")}</div>`:""}
    </div>`);

  cards.push(`
    <div class="card">
      <div class="mini"><strong>Lavoro & Reddito</strong></div>
      <ul class="list">
        <li>Lavoro: <strong>${lavoroTipo}</strong> • Pasti: <strong>${pasto}</strong></li>
        <li>Reddito: <strong>${reddito}</strong></li>
      </ul>
    </div>`);

  cards.push(`
    <div class="card">
      <div class="mini"><strong>Incidenti</strong></div>
      <div>${S.incidents.length? S.incidents.map(i=>`<span class="chip">${i.tipo} • ${i.sev}${i.anno?` • ${i.anno}`:''}</span>`).join(' ') : `<span class="muted">Nessuno</span>`}</div>
    </div>`);

  cards.push(`
    <div class="card">
      <div class="mini"><strong>Patologie</strong></div>
      <div>${S.diseases.length? S.diseases.map(d=>`<span class="chip">${d.part} • ${d.cat} • ${d.det}</span>`).join(' ') : `<span class="muted">Nessuna</span>`}</div>
    </div>`);

  cards.push(`
    <div class="card">
      <div class="mini"><strong>Stress & Droghe</strong></div>
      <ul class="list">
        <li>Stress: <strong>${stress}/10</strong> ${stressTrig.length?`• Trigger: ${stressTrig.join(", ")}`:""}</li>
        <li>Droghe: ${S.drugs.length? S.drugs.map(d=>`<span class="chip">${d.tipo} • ${d.freq}</span>`).join(' ') : `<span class="muted">Nessun uso dichiarato</span>`}</li>
      </ul>
    </div>`);

  if(isF){
    cards.push(`
      <div class="card">
        <div class="mini"><strong>Parti</strong></div>
        <ul class="list">
          <li>Numero: <strong>${numParti}</strong> • Tipo prevalente: <strong>${tipoParto}</strong> • Complicazioni: <strong>${compParto}</strong></li>
        </ul>
      </div>`);
  }

  if(S.inferred.length){
    cards.push(`<div class="card"><div class="mini"><strong>Inferenze</strong></div><ul class="list">${S.inferred.map(x=>`<li>${x}</li>`).join('')}</ul></div>`);
  }

  el("#summaryCards").innerHTML = cards.join('');
}

/* ===== Calcolo ===== */
function ageFromDOB(dateStr){
  if(!dateStr) return 40;
  const dob = new Date(dateStr), t=new Date();
  let a = t.getFullYear()-dob.getFullYear();
  const m=t.getMonth()-dob.getMonth();
  if(m<0 || (m===0 && t.getDate()<dob.getDate())) a--;
  return Math.max(0,a);
}
function baselineFromCountries(){
  let totalY=0,sum=0;
  S.timeline.forEach(t=>{ const y=(t.al-t.dal+1); const le=LIFE_EXP[t.paese]||78; sum+=le*y; totalY+=y; });
  if(totalY===0){ return LIFE_EXP[el("#residenza").value]||78; }
  return sum/totalY;
}
function envAdj(env){ return env==="mare"?0.6:env==="montagna"?0.4:env==="campagna"?0.3:0; }

function lifestyleScoreYears(){
  const sportG=+el("#sportGiorni").value||0, passi=+el("#passi").value||0, sonno=+el("#sonno").value||0;
  const dieta=el("#dieta").value, idr=el("#idratazione").value, alcol=el("#alcol").value;
  const hNow=+el("#hNow").value||0, wNow=+el("#wNow").value||0;

  let pts=0;
  pts += Math.min(10, sportG*2);
  if(passi>=9000) pts+=8; else if(passi>=7000) pts+=5; else if(passi>=5000) pts+=2; else pts-=3;
  if(sonno>=7 && sonno<=9) pts+=5; else if(sonno<6) pts-=5; else if(sonno>10) pts-=2;
  if(dieta==="sana") pts+=8; else if(dieta==="scorretta") pts-=8;
  if(idr==="acqua") pts+=4; else if(idr==="zuccherate") pts-=6;
  if(alcol==="alto") pts-=8; else if(alcol==="moderato") pts-=2;
  if(hNow&&wNow){
    const bmi=wNow/Math.pow(hNow/100,2);
    if(bmi<18.5) pts-=4; else if(bmi<25) pts+=6; else if(bmi<30) pts-=4; else pts-=10;
  }
  pts = Math.max(-30,Math.min(30,pts));
  return pts*0.3; // conversione punti→anni
}
function smokingYears(){
  const fumoTab=el("#fumoTab").value, sigDie=+el("#sigDie").value||0, anniFumo=+el("#anniFumo").value||0;
  const svapo=el("#svapo").value, svFreq=+el("#svapoFreq").value||0;
  let y=0;
  if(fumoTab!=="no"){
    const packYears = (sigDie/20)*anniFumo;
    y += -Math.min(12, packYears*0.5); // forte impatto cumulativo
    if(fumoTab==="sigari"||fumoTab==="pipa") y += -1.5;
  }
  if(svapo!=="no"){
    if(svapo==="siNic") y += -Math.min(4, svFreq*0.01 + 1.0);
    else y += -Math.min(2, svFreq*0.005 + 0.4);
  }
  return y;
}
function workYears(){
  const job=JOBS[el("#lavoroTipo").value]; if(!job) return 0;
  return job.years||0;
}
function incomeYears(){
  const r=el("#reddito").value;
  if(r==="basso") return -1.0;
  if(r==="medio-basso") return -0.4;
  if(r==="medio") return 0.2;
  if(r==="alto") return 0.6;
  if(r==="molto-alto") return 0.8;
  return 0;
}
function mealYears(){ return el("#pasto").value==="fretta" ? -0.3 : 0.2; }
function diseaseYears(){
  const sum=S.diseases.reduce((a,d)=>a+(d.score||0),0);
  return Math.max(-70,sum)*0.6; // come v1
}
function incidentsYears(){
  const sum=S.incidents.reduce((a,i)=>a+(i.score||0),0);
  return Math.max(-35,sum)*0.5;
}
function drugsYears(){
  const sum=S.drugs.reduce((a,d)=>a+(d.score||0),0);
  return Math.max(-40,sum)*0.6;
}
function femaleBirthYears(){
  if(el("#sesso").value!=="F") return 0;
  const n=+el("#numParti").value||0, tipo=el("#tipoParto").value, comp=el("#compParto").value;
  let y = 0;
  if(n>0){
    // effetti medio-piccoli (stile letteratura mista)
    y += Math.min(1.0, n*0.15); // parità lieve protezione
    if(tipo==="cesareo") y -= Math.min(0.8, n*0.1);
    if(comp==="lievi") y -= 0.2;
    if(comp==="gravi") y -= 1.0;
  }
  return y;
}
function stressYears(){
  const s=+el("#stress").value||0;
  let y = -(s*0.15); // fino a -1.5 anni circa
  return y;
}
function futureAdj(){
  if(el("#trasferFuturo").value!=="si") return 0;
  const paese = el("#paeseFuturo").value;
  const target = LIFE_EXP[paese] || 78;
  const base = baselineFromCountries();
  const delta = target - base;
  return delta * 0.2; // incertezza
}
function sexYears(){
  const sx=el("#sesso").value;
  if(sx==="F") return +1.8;
  if(sx==="M") return 0;
  return +0.5;
}
function cohortYears(){
  const a=ageFromDOB(el("#dob").value);
  if(a<40) return 1.5;
  if(a<=60) return 0.6;
  return 0.2;
}

function computeExpectedAge(){
  const base=baselineFromCountries();
  const env=envAdj(el("#ambiente").value);
  const life=lifestyleScoreYears();
  const smoke=smokingYears();
  const job=workYears();
  const income=incomeYears();
  const meal=mealYears();
  const dis=diseaseYears();
  const inc=incidentsYears();
  const drug=drugsYears();
  const fem=femaleBirthYears();
  const stress=stressYears();
  const fut=futureAdj();
  const sex=sexYears();
  const coh=cohortYears();

  let expected = base + env + life + smoke + job + income + meal + dis + inc + drug + fem + stress + fut + sex + coh;
  expected = Math.max(50, Math.min(108, expected));

  // Health index: combina (in punti) per un range -100..+100
  const health = Math.max(-100, Math.min(100,
    (life/0.3)*2 + (dis/0.6)*1.2 + (inc/0.5)*0.8 + (smoke)*3 + (drug/0.6)*1.2 - (stress*8) + (income*10)
  ));

  return {expected, health, comp:{base,env,life,smoke,job,income,meal,dis,inc,drug,fem,stress,fut,sex,coh}};
}

function milestoneProbs(expected, currentAge){
  const spread = 9;
  const ages=[70,80,90,100,110]; const probs={};
  ages.forEach(a=>{ const p=1/(1+Math.exp((a-expected)/spread)); probs[a]=currentAge>=a?1:p; });
  return probs;
}
function fmtPct(x){ return Math.round(x*100); }

function compute(){
  const {expected, health, comp} = computeExpectedAge();
  const name = el("#nome").value?.trim()||"Tu";
  const age = ageFromDOB(el("#dob").value);
  const today=new Date();
  const yrs = Math.max(0, expected - age);
  const date = new Date(today.getFullYear()+Math.round(yrs), today.getMonth(), today.getDate());

  // Render
  el("#resultHead").textContent = `${name}, stima ludica: ${expected.toFixed(1)} anni`;
  el("#etaStimata").textContent = `${expected.toFixed(1)} anni`;
  el("#saluteScore").textContent = `${Math.round(health)}`;
  el("#resultDate").innerHTML = `Data indicativa (non reale): <strong>${date.toLocaleDateString("it-IT")}</strong> — anni residui ~ <strong>${yrs.toFixed(1)}</strong>`;

  const probs = milestoneProbs(expected, age);
  el("#milestones").innerHTML = [70,80,90,100,110].map(a=>{
    const p=probs[a]; const cls=p>=0.7?'ok':p>=0.4?'warn':'danger';
    return `<tr><td>${a} anni</td><td><span class="${cls}"><strong>${fmtPct(p)}%</strong></span></td></tr>`;
  }).join('');

  const drivers=[];
  drivers.push(`Base Paesi/Residenza: <strong>${comp.base.toFixed(1)}</strong> anni`);
  if(comp.env) drivers.push(`Ambiente: ${comp.env>0?'+':''}${comp.env.toFixed(1)} anni`);
  if(comp.life) drivers.push(`Stile di vita: ${comp.life>0?'+':''}${comp.life.toFixed(1)} anni`);
  if(comp.smoke) drivers.push(`Fumo/svapo: ${comp.smoke.toFixed(1)} anni`);
  if(comp.job) drivers.push(`Lavoro: ${comp.job.toFixed(1)} anni`);
  if(comp.income) drivers.push(`Reddito: ${comp.income>0?'+':''}${comp.income.toFixed(1)} anni`);
  if(comp.meal) drivers.push(`Ritmo pasti: ${comp.meal>0?'+':''}${comp.meal.toFixed(1)} anni`);
  if(comp.dis) drivers.push(`Patologie: ${comp.dis.toFixed(1)} anni`);
  if(comp.inc) drivers.push(`Incidenti: ${comp.inc.toFixed(1)} anni`);
  if(comp.drug) drivers.push(`Droghe: ${comp.drug.toFixed(1)} anni`);
  if(comp.fem) drivers.push(`Parti/complicazioni: ${comp.fem>0?'+':''}${comp.fem.toFixed(1)} anni`);
  if(comp.stress) drivers.push(`Stress: ${comp.stress.toFixed(1)} anni`);
  if(comp.fut) drivers.push(`Trasferim. futuro: ${comp.fut>0?'+':''}${comp.fut.toFixed(1)} anni`);
  if(comp.sex) drivers.push(`Sesso: ${comp.sex>0?'+':''}${comp.sex.toFixed(1)} anni`);
  if(comp.coh) drivers.push(`Coorte/progresso: +${comp.coh.toFixed(1)} anni`);
  el("#drivers").innerHTML = drivers.map(d=>`<li>${d}</li>`).join('');

  // Consigli (semplici euristiche)
  const tips=[];
  const passi=+el("#passi").value||0; if(passi<7000) tips.push("Porta gradualmente i passi a 7–9k/die (salute cardio-metabolica).");
  const sonno=+el("#sonno").value||0; if(sonno<7||sonno>9) tips.push("Punta a 7–9 ore di sonno costanti (igiene del sonno).");
  const idr=el("#idratazione").value; if(idr!=="acqua") tips.push("Riduci le bevande zuccherate: sostituiscile con acqua/infusi.");
  const alcol=el("#alcol").value; if(alcol!=="no") tips.push("Contieni l’alcol entro linee guida o valuta settimane ‘dry’.");
  const fumoTab=el("#fumoTab").value; if(fumoTab!=="no") tips.push("Percorso di cessazione dal tabacco (supporto medico/app/terapia).");
  const svapo=el("#svapo").value; if(svapo!=="no") tips.push("Se svapi: riduci frequenza e nicotina fino a stop.");
  const bmiH=+el("#hNow").value||0, bmiW=+el("#wNow").value||0;
  if(bmiH&&bmiW){ const bmi=bmiW/Math.pow(bmiH/100,2); if(bmi>=25) tips.push("Deficit calorico lieve, +proteine, +movimento per riportare il BMI in 20–25."); }
  const job = JOBS[el("#lavoroTipo").value]; if(job?.expo?.dust||job?.expo?.silica) tips.push("Usa DPI certificati (FFP3 per polveri/silice) e monitoraggi periodici.");
  if(job?.expo?.chem) tips.push("Ventilazione/aspirazione localizzata e DPI per solventi/vernici.");
  if(job?.expo?.night) tips.push("Turni: cura l’igiene circadiana (luce diurna, blocco blu la sera).");
  const stressV=+el("#stress").value||0; if(stressV>=5) tips.push("Protocollo anti-stress: 10’ respiro 4-6, 20’ passeggiata, journaling serale.");
  if(S.drugs.length) tips.push("Se usi sostanze: valuta un consulto riservato per riduzione del danno.");
  if(tips.length===0) tips.push("Ottimo profilo! Mantieni le abitudini e controlli periodici di prevenzione.");
  el("#tips").innerHTML = tips.map(t=>`<li>${t}</li>`).join('');

  showStep(8);
}

/* Hook calcolo e ricomincia */
el("#doCalc").addEventListener("click", compute);
el("#ricomincia").addEventListener("click", ()=>location.reload());

/* Stepper iniziale */
showStep(1);
document.getElementById("year").textContent = new Date().getFullYear();
</script>
</body>
</html>