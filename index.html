<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Calcolatore Longevità — v3 (by Stephan Winckler)</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#38bdf8; --accent2:#22c55e; --danger:#ef4444; --warn:#f59e0b; --ok:#10b981;
    --b:#1f2937; --card:#0b1424;
  }
  /* Tema chiaro */
  :root.light{
    --bg:#f5f7fb; --panel:#ffffff; --muted:#475569; --text:#0f172a;
    --accent:#0284c7; --accent2:#16a34a; --danger:#dc2626; --warn:#d97706; --ok:#059669;
    --b:#e2e8f0; --card:#ffffff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0; height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{
    position:sticky; top:0; z-index:30;
    background:rgba(12,18,34,.9); backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid var(--b);
  }
  :root.light header{background:rgba(255,255,255,.85)}
  .h-wrap{max-width:1100px; margin:0 auto; padding:10px 16px calc(10px + env(safe-area-inset-top)) 16px; display:flex; gap:10px; align-items:center}
  h1{margin:4px 0 8px; font-size:clamp(18px,4vw,24px); flex:1}
  .muted{color:var(--muted)}
  .progress{height:8px; width:100%; background:#0a1222; border:1px solid var(--b); border-radius:999px; overflow:hidden}
  :root.light .progress{background:#eef2f7}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#60a5fa,var(--accent2)); transition:width .3s}

  .container{max-width:1100px; margin:10px auto 96px; padding:0 12px}
  .panel{
    background:linear-gradient(180deg, var(--panel), var(--panel));
    border:1px solid var(--b); border-radius:14px; padding:14px; margin:10px 0;
    box-shadow:0 10px 30px rgba(0,0,0,.15), inset 0 1px 0 rgba(255,255,255,.03)
  }
  .section-title{margin:0 0 8px; font-size:16px; color:#4f9cff}
  :root.light .section-title{color:#0ea5e9}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .col{flex:1 1 240px; min-width:210px}
  label{display:block; font-size:13px; color:var(--muted); margin:6px 0}
  input, select, textarea{
    width:100%; padding:11px 12px; border-radius:12px; background:#0a1222; border:1px solid var(--b); color:var(--text);
    font-size:16px; outline:none
  }
  :root.light input,:root.light select,:root.light textarea{background:#ffffff}
  input:focus, select:focus, textarea:focus{border-color:var(--accent)}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; background:linear-gradient(180deg,var(--accent),#0284c7); border:1px solid #0369a1; color:#fff; font-weight:600; cursor:pointer}
  .btn.secondary{background:#101826; border-color:var(--b)}
  :root.light .btn.secondary{background:#ffffff}
  .btn.ghost{background:transparent; border:1px dashed #334155; color:var(--text)}
  .btn.small{padding:8px 10px; font-size:13px; border-radius:10px}
  .btn.inline{padding:6px 10px; font-size:12px}
  .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:10px}
  .card{background:var(--card); border:1px solid var(--b); border-radius:12px; padding:12px}
  :root.light .card{background:#fff}
  .badge,.pill,.chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--b); font-size:12px}
  .pill{background:#0b1a2e; color:#a5b4fc}
  :root.light .pill{background:#eaf4ff; color:#2563eb}
  .chip{background:#0b1a2e} :root.light .chip{background:#f1f5f9}
  .mini{font-size:12px; color:var(--muted)}
  .helper{font-size:12px; color:var(--muted); margin-top:6px}
  .table{width:100%; border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--b); padding:8px; text-align:left; font-size:14px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}

  .foot-nav{
    position:fixed; left:0; right:0; bottom:0; z-index:40;
    background:rgba(8,12,24,.95); border-top:1px solid var(--b);
    padding:8px 12px calc(8px + env(safe-area-inset-bottom));
    display:flex; gap:8px
  }
  :root.light .foot-nav{background:rgba(255,255,255,.95)}
  .foot-nav .btn{flex:1 1 50%}
  footer.legal{
    margin:20px auto; max-width:1100px; color:var(--muted); font-size:12px; padding:0 12px 80px;
  }
  @media (max-width:480px){
    .h-wrap{padding:8px 12px calc(8px + env(safe-area-inset-top)) 12px}
    .container{margin-top:6px}
  }

  /* Sezione stampabile (report) */
  @media print{
    header,.foot-nav, .no-print{display:none!important}
    body{background:#fff; color:#000}
    .panel{box-shadow:none; border:0; padding:0}
    .container{margin:0; max-width:100%}
  }
</style>
</head>
<body>
  <header>
    <div class="h-wrap">
      <h1>Calcolatore di Longevità <span class="muted">— stima ludica & motivazionale</span></h1>
      <button id="themeToggle" class="btn inline no-print" title="Tema chiaro/scuro">🌓</button>
      <button id="installBtn" class="btn inline no-print" title="Aggiungi alla Home">📲</button>
    </div>
    <div class="h-wrap" style="padding-top:0">
      <div class="progress"><div id="bar" class="bar"></div></div>
    </div>
  </header>

  <div class="container" id="app">

    <!-- STEP 1 -->
    <section class="panel step-panel" data-step="1">
      <h2 class="section-title">1) Dati anagrafici</h2>
      <div class="row">
        <div class="col"><label>Nome e cognome</label><input id="nome" placeholder="Es. Mario Rossi"></div>
        <div class="col"><label>Data di nascita</label><input id="dob" type="date"></div>
        <div class="col">
          <label>Sesso</label>
          <select id="sesso"><option value="nd">Preferisco non dirlo</option><option value="M">Maschio</option><option value="F">Femmina</option><option value="altro">Altro</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col"><label>Residenza attuale (Paese)</label><select id="residenza"></select></div>
        <div class="col">
          <label>Ambiente</label>
          <select id="ambiente"><option value="citta">Città</option><option value="mare">Mare</option><option value="montagna">Montagna</option><option value="campagna">Campagna</option></select>
        </div>
        <div class="col">
          <label>Pianifichi trasferimento futuro?</label>
          <select id="trasferFuturo"><option value="no">No</option><option value="si">Sì</option></select>
        </div>
      </div>
      <div id="futuroBox" class="row" style="display:none">
        <div class="col"><label>Paese di trasferimento (ipotetico)</label><select id="paeseFuturo"></select></div>
        <div class="col"><label>Anno previsto (indicativo)</label><input id="annoFuturo" type="number" min="2025" max="2100" placeholder="Es. 2030"></div>
      </div>
      <div class="row no-print" style="gap:6px;margin-top:6px">
        <button id="exportJSON" class="btn ghost small">💾 Esporta JSON</button>
        <label class="btn ghost small" for="importJSON">📥 Importa JSON</label>
        <input id="importJSON" type="file" accept="application/json" style="display:none">
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="panel step-panel" data-step="2" hidden>
      <h2 class="section-title">2) Dove hai vissuto (timeline)</h2>
      <div class="row">
        <div class="col"><label>Paese</label><select id="paeseTimeline"></select></div>
        <div class="col"><label>Dal (anno)</label><input id="dalAnno" type="number" min="1900" max="2100"></div>
        <div class="col"><label>Al (anno)</label><input id="alAnno" type="number" min="1900" max="2100"></div>
        <div class="col" style="min-width:160px"><label>&nbsp;</label><button id="addTimeline" class="btn">Aggiungi</button></div>
      </div>
      <div id="timelineList" class="cards"></div>
    </section>

    <!-- STEP 3 -->
    <section class="panel step-panel" data-step="3" hidden>
      <h2 class="section-title">3) Stile di vita</h2>
      <div class="row">
        <div class="col"><label>Attività fisica (giorni/settimana)</label><input id="sportGiorni" type="number" min="0" max="7" placeholder="0–7"></div>
        <div class="col"><label>Passi medi al giorno</label><input id="passi" type="number" min="0" step="100" placeholder="Es. 8000"></div>
        <div class="col"><label>Ore di sonno/notte</label><input id="sonno" type="number" min="0" max="14" step="0.5" placeholder="Es. 7.5"></div>
      </div>
      <div class="row">
        <div class="col"><label>Dieta</label>
          <select id="dieta">
            <option value="sana">Sana (verdura, legumi, pesce, pochi ultraprocessati)</option>
            <option value="mista">Mista/variabile</option>
            <option value="scorretta">Scorretta (fast food/ultraprocessati frequenti)</option>
          </select>
        </div>
        <div class="col"><label>Idratazione</label>
          <select id="idratazione"><option value="acqua">Prevalentemente acqua</option><option value="mista">Acqua + bevande zuccherate</option><option value="zuccherate">Quasi solo bevande zuccherate</option></select>
        </div>
        <div class="col"><label>Alcol</label>
          <select id="alcol"><option value="no">Raramente/mai</option><option value="moderato">Moderato</option><option value="alto">Alto</option></select>
        </div>
      </div>

      <hr>
      <h3 class="section-title">Fumo</h3>
      <div class="row">
        <div class="col"><label>Fumi tabacco?</label>
          <select id="fumoTab"><option value="no">No</option><option value="sigarette">Sigarette</option><option value="sigari">Sigari</option><option value="pipa">Pipa</option></select>
        </div>
        <div class="col"><label>Sigarette/die (se applicabile)</label><input id="sigDie" type="number" min="0" max="60"></div>
        <div class="col"><label>Anni di fumo</label><input id="anniFumo" type="number" min="0" max="80"></div>
      </div>
      <div class="row">
        <div class="col"><label>Usi sigaretta elettronica (svapo)?</label>
          <select id="svapo"><option value="no">No</option><option value="siNic">Sì, con nicotina</option><option value="siNoNic">Sì, senza nicotina</option></select>
        </div>
        <div class="col"><label>Frequenza svapo (tiri/giorno approx)</label><input id="svapoFreq" type="number" min="0" max="1000"></div>
      </div>

      <hr>
      <h3 class="section-title">BMI (presente e passato)</h3>
      <div class="row">
        <div class="col"><label>Altezza attuale (cm)</label><input id="hNow" type="number" min="100" max="240" placeholder="170"></div>
        <div class="col"><label>Peso attuale (kg)</label><input id="wNow" type="number" min="30" max="300" step="0.1" placeholder="80.0"></div>
        <div class="col" style="min-width:180px"><label>&nbsp;</label><button class="btn" id="calcBMI">Calcola BMI</button></div>
      </div>
      <div id="bmiNowOut" class="helper"></div>
      <div class="card" style="margin-top:8px">
        <div class="mini">BMI passati (facoltativo)</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Data</label><input id="pastDate" type="date"></div>
          <div class="col"><label>Altezza (cm)</label><input id="pastH" type="number" min="100" max="240"></div>
          <div class="col"><label>Peso (kg)</label><input id="pastW" type="number" min="30" max="300" step="0.1"></div>
          <div class="col" style="min-width:160px"><label>&nbsp;</label><button class="btn ghost" id="addPastBMI">Aggiungi BMI passato</button></div>
        </div>
        <div id="pastBMIList" class="cards" style="margin-top:6px"></div>
        <canvas id="bmiChart" height="160" style="margin-top:10px;width:100%;background:transparent;border:1px dashed var(--b);border-radius:8px"></canvas>
      </div>
    </section>

    <!-- STEP 4 -->
    <section class="panel step-panel" data-step="4" hidden>
      <h2 class="section-title">4) Lavoro, reddito & pasti</h2>
      <div class="row">
        <div class="col">
          <label>Lavoro principale</label>
          <select id="lavoroTipo"></select>
        </div>
        <div class="col">
          <label>Ritmo dei pasti al lavoro</label>
          <select id="pasto"><option value="calma">Con calma</option><option value="fretta">Di fretta</option></select>
        </div>
        <div class="col">
          <label>Fascia di reddito annuo</label>
          <select id="reddito">
            <option value="basso">&lt; €15k</option>
            <option value="medio-basso">€15k–€30k</option>
            <option value="medio">€30k–€60k</option>
            <option value="alto">€60k–€120k</option>
            <option value="molto-alto">&gt; €120k</option>
          </select>
        </div>
      </div>
      <div class="helper">Il lavoro incide per esposizioni (polveri, solventi, rumore, turni, vibrazioni), il reddito come proxy di accesso a prevenzione e stress finanziario.</div>
    </section>

    <!-- STEP 5 -->
    <section class="panel step-panel" data-step="5" hidden>
      <h2 class="section-title">5) Incidenti & Patologie</h2>
      <div class="card">
        <div class="mini"><strong>Incidenti avuti</strong> — seleziona evento e severità, aggiungi tutti i rilevanti.</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Tipo incidente</label><select id="incTipo"></select></div>
          <div class="col"><label>Severità</label><select id="incSev"></select></div>
          <div class="col"><label>Anno (facolt.)</label><input id="incAnno" type="number" min="1900" max="2100"></div>
          <div class="col" style="min-width:160px"><label>&nbsp;</label><button class="btn" id="addInc">Aggiungi incidente</button></div>
        </div>
        <div id="incList" class="cards" style="margin-top:6px"></div>
      </div>

      <hr>

      <div class="card">
        <div class="mini"><strong>Patologie</strong> — parte del corpo → categoria → dettaglio.</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Parte del corpo</label><select id="bodyPart"></select></div>
          <div class="col"><label>Categoria</label><select id="diseaseCat"></select></div>
          <div class="col"><label>Dettaglio</label><select id="diseaseDetail"></select></div>
          <div class="col" style="min-width:160px"><label>&nbsp;</label><button id="addDisease" class="btn">Aggiungi patologia</button></div>
        </div>
        <div id="diseaseList" class="cards" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- STEP 6 -->
    <section class="panel step-panel" data-step="6" hidden>
      <h2 class="section-title">6) Fattori aggiuntivi</h2>
      <div class="card" id="femaleBox" style="display:none">
        <div class="mini"><strong>Gravidanze/Parti (solo se donna)</strong></div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Numero di parti</label><input id="numParti" type="number" min="0" max="20" value="0"></div>
          <div class="col">
            <label>Tipologia prevalente</label>
            <select id="tipoParto"><option value="nessuno">Nessuno</option><option value="naturale">Naturale</option><option value="cesareo">Cesareo</option></select>
          </div>
          <div class="col">
            <label>Complicazioni significative?</label>
            <select id="compParto"><option value="no">No</option><option value="lievi">Lievi</option><option value="gravi">Gravi</option></select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="mini"><strong>Stress</strong> — autovalutazione & fattori.</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Stress percepito (0–10)</label><input id="stress" type="number" min="0" max="10" value="3"></div>
          <div class="col">
            <label>Trigger principali</label>
            <select id="stressTrig" multiple size="4" style="height:100px">
              <option>Debiti/pressione finanziaria</option>
              <option>Turni/notte</option>
              <option>Caregiver (familiari)</option>
              <option>Precarietà lavorativa</option>
              <option>Traffico/pendolarismo</option>
              <option>Isolamento sociale</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="mini"><strong>Droghe</strong> — <span class="ok">Questi dati non vengono salvati da nessuna parte</span>: servono solo per un punteggio aggregato locale.</div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>Uso di droghe?</label>
            <select id="drogheUso"><option value="no">No</option><option value="si">Sì</option></select>
          </div>
          <div class="col"><label>Tipo</label><select id="drogaTipo"></select></div>
          <div class="col"><label>Frequenza</label>
            <select id="drogaFreq">
              <option>Occasionale (&lt;1/mese)</option>
              <option>Mensile</option>
              <option>Settimanale</option>
              <option>Giornaliera</option>
            </select>
          </div>
          <div class="col" style="min-width:160px"><label>&nbsp;</label><button class="btn" id="addDroga">Aggiungi</button></div>
        </div>
        <div id="drogaList" class="cards" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- STEP 7 -->
    <section class="panel step-panel" data-step="7" hidden>
      <h2 class="section-title">7) Riepilogo</h2>
      <div id="summaryCards" class="cards"></div>
      <div class="helper">Controlla i dati. Se qualcosa non torna, torna indietro e correggi. Poi avvia il calcolo.</div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="doCalc">Avvia calcolo</button>
      </div>
    </section>

    <!-- STEP 8 -->
    <section class="panel step-panel" data-step="8" hidden>
      <h2 class="section-title">Risultato & Probabilità traguardi</h2>
      <div id="resultHead" style="font-size:clamp(22px,5vw,34px); font-weight:800"></div>
      <p id="resultDate" class="muted"></p>
      <div class="row">
        <div class="col card"><div class="mini">Età stimata (media)</div><div id="etaStimata" style="font-size:22px; margin-top:6px">–</div></div>
        <div class="col card"><div class="mini">Indice salute (–100 → +100)</div><div id="saluteScore" style="font-size:22px; margin-top:6px">–</div></div>
      </div>
      <div class="card" style="margin-top:8px">
        <table class="table"><thead><tr><th>Traguardo</th><th>Probabilità</th></tr></thead><tbody id="milestones"></tbody></table>
      </div>
      <div class="card" style="margin-top:8px">
        <div class="mini"><strong>Fattori principali che hanno inciso</strong></div>
        <ul id="drivers" class="list" style="margin-top:6px"></ul>
      </div>
      <div class="card" style="margin-top:8px">
        <div class="mini"><strong>Consigli personalizzati</strong></div>
        <ul id="tips" class="list" style="margin-top:6px"></ul>
        <div id="potentialGain" class="helper" style="margin-top:6px"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="ricomincia">Ricomincia</button>
        <button class="btn" id="exportReport">📄 Esporta/Salva</button>
      </div>
    </section>
  </div>

  <!-- Mobile nav -->
  <div class="foot-nav no-print">
    <button class="btn secondary" id="backBtn">Indietro</button>
    <button class="btn" id="nextBtn">Avanti</button>
  </div>

  <footer class="legal">
    Creata da <strong>Stephan Winckler</strong> per divertimento. Non è un consiglio medico: prendetela con leggerezza,
    ma usatela per darvi una regolata e migliorare le abitudini verso traguardi più lontani. © <span id="year"></span>
  </footer>

<script>
/* ====== Tema ====== */
const root = document.documentElement;
document.getElementById('themeToggle').addEventListener('click',()=>{
  root.classList.toggle('light');
  localStorage.setItem('theme', root.classList.contains('light')?'light':'dark');
});
if(localStorage.getItem('theme')==='light'){ root.classList.add('light'); }

/* ====== PWA (manifest + service worker via Blob) ====== */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; });
document.getElementById('installBtn').addEventListener('click', async ()=>{
  if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; }
  else alert("Se il pulsante non appare, usa 'Aggiungi alla schermata Home' dal menu del browser.");
});
(function setupPWA(){
  const manifest = {
    name:"Calcolatore Longevità",
    short_name:"Longevità",
    start_url:"./",
    display:"standalone",
    background_color:"#0f172a",
    theme_color:"#0f172a",
    icons:[]
  };
  const manURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/json'}));
  const link=document.createElement('link'); link.rel='manifest'; link.href=manURL; document.head.appendChild(link);

  const swCode = `
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open('longevita-v3').then(c=>c.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', e=>{
      e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request)));
    });
  `;
  const swURL = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
  if('serviceWorker' in navigator){ navigator.serviceWorker.register(swURL); }
})();

/* ===== Dataset: Aspettative di vita (indicativo) ===== */
const LIFE_EXP = {
 "Italia":83,"San Marino":84,"Spagna":83,"Francia":82,"Svizzera":84,"Germania":81,"Austria":82,"Regno Unito":81,
 "Irlanda":82,"Islanda":83,"Norvegia":83,"Svezia":82,"Finlandia":82,"Paesi Bassi":82,"Belgio":82,"Danimarca":81,
 "Portogallo":81,"Grecia":81,"USA":77,"Canada":82,"Messico":75,"Brasile":76,"Argentina":77,"Cile":79,"Colombia":77,
 "Perù":77,"Uruguay":78,"Giappone":84,"Corea del Sud":83,"Cina":78,"India":70,"Pakistan":67,"Bangladesh":73,
 "Sri Lanka":77,"Nepal":71,"Emirati Arabi Uniti":79,"Arabia Saudita":76,"Qatar":81,"Israele":83,"Turchia":78,
 "Marocco":75,"Tunisia":74,"Egitto":70,"Sudafrica":64,"Etiopia":67,"Kenya":66,"Nigeria":55,
 "Russia":71,"Ucraina":70,"Polonia":78,"Repubblica Ceca":79,"Slovacchia":77,"Ungheria":76,"Romania":75,
 "Bulgaria":74,"Croazia":78,"Slovenia":81,"Serbia":75,"Bosnia":75,"Albania":76,"Macedonia del Nord":75,
 "Lituania":76,"Lettonia":75,"Estonia":78,"Australia":83,"Nuova Zelanda":82
};
const COUNTRIES = Object.keys(LIFE_EXP).sort((a,b)=>a.localeCompare(b,'it'));

/* ===== Lavori e fattori (anni +/-) ===== */
const JOBS = {
  "Ufficio/Impiegato sedentario": {years:-0.5, notes:["Sedentarietà"], expo:{sedent:true}},
  "IT/Programmatore": {years:-0.5, notes:["Sedentarietà/occhi"], expo:{sedent:true}},
  "Sanità (turni)": {years:-1.2, notes:["Turni/notte","stress"], expo:{night:true}},
  "Ristorazione (sala/cucina)": {years:-0.8, notes:["Turni","stress","calore"], expo:{heat:true}},
  "Autista/Trasporti": {years:-1.0, notes:["Seduto a lungo","turni"], expo:{sedent:true,night:true}},
  "Agricoltura": {years:-0.8, notes:["Polveri/pesticidi","sforzo"], expo:{dust:true,chem:true,phys:true}},
  "Edilizia": {years:-1.5, notes:["Polveri","rumore","cadute"], expo:{dust:true,noise:true,phys:true}},
  "Miniera/Cava": {years:-3.0, notes:["Silice","profondità"], expo:{silica:true,dust:true}},
  "Metalmeccanica/Officina": {years:-1.2, notes:["Rumore","solventi","vibrazioni"], expo:{noise:true,chem:true,vib:true}},
  "Carrozziere/Verniciatura": {years:-1.8, notes:["Solventi/vernici"], expo:{chem:true}},
  "Chimico/Industria chimica": {years:-1.6, notes:["Solventi"], expo:{chem:true}},
  "Polizia/VVF/Forze armate": {years:-1.0, notes:["Stress","rischio"], expo:{stress:true}},
  "Logistica/Magazzino pesante": {years:-1.0, notes:["Sforzo","vibrazioni"], expo:{phys:true,vib:true}},
  "Subacqueo/Alta quota": {years:-1.4, notes:["Pressione/altitudine"], expo:{pressure:true}},
  "Insegnante": {years:-0.2, notes:["Stress moderato"], expo:{stress:true}},
  "Commercio/Negozio": {years:-0.2, notes:["In piedi"], expo:{phys:true}},
  "Disoccupato": {years:-0.8, notes:["Stress economico, inattività"], expo:{stress:true,sedent:true}},
  "Studente": {years:-0.4, notes:["Stress esami, sedentarietà"], expo:{stress:true,sedent:true}}
};

/* ===== Malattie (punteggi negativi) ===== */
const DISEASES = {
 "Cardio-vascolare":{
   "Ipertensione":{"Lieve":-4,"Moderata":-8,"Grave":-12},
   "Cardiopatia ischemica":{"Stabile":-10,"Recente evento":-18,"Insufficienza cardiaca":-22},
   "Aritmie":{"Benigne":-3,"Con terapia":-6,"Complesse":-10}
 },
 "Metabolico":{
   "Diabete":{"Tipo 2 ben controllato":-6,"Tipo 2 non controllato":-14,"Tipo 1":-10},
   "Dislipidemia":{"Lieve":-3,"Importante":-7},
   "Tiroide":{"Ipotiroidismo controllato":-2,"Ipertiroidismo":-4}
 },
 "Respiratorio":{
   "Asma":{"Lieve":-2,"Moderata":-5,"Grave":-9},
   "BPCO":{"Stadio iniziale":-8,"Avanzata":-16},
   "Apnea notturna":{"Lieve":-3,"Moderata":-6,"Grave":-9}
 },
 "Neurologico":{
   "Epilessia":{"Ben controllata":-3,"Non controllata":-10},
   "Ictus pregresso":{"Lieve esiti":-12,"Esiti importanti":-20},
   "Parkinson":{"Iniziale":-8,"Avanzato":-15},
   "Demenza":{"Iniziale":-10,"Avanzata":-18}
 },
 "Oncologico":{
   "Neoplasia":{"In remissione":-8,"In trattamento":-18,"Metastatica":-28}
 },
 "Rene/Fegato":{
   "Insufficienza renale":{"Lieve":-6,"Moderata":-12,"Grave":-20},
   "Epatopatia":{"Steatosi":-4,"Fibrosi/Cirrosi":-14},
   "Epatite cronica":{"Controllata":-4,"Attiva":-8}
 },
 "Muscolo-scheletrico":{
   "Obesità":{"Classe I":-6,"Classe II":-10,"Classe III":-16},
   "Sarcopenia":{"Moderata":-6,"Importante":-12},
   "Osteoporosi":{"Moderata":-4,"Grave":-7}
 },
 "Psiche":{
   "Depressione":{"Lieve":-3,"Moderata":-6,"Grave":-10},
   "Disturbi d'ansia":{"Lieve":-2,"Moderati":-4,"Gravi":-7},
   "Dipendenze":{"Alcol":-10,"Sostanze":-12}
 }
};

/* ===== Incidenti (punteggi negativi) ===== */
const INCIDENTS = {
  "Stradale": {"Lieve":-2,"Moderato":-5,"Grave":-10,"Trauma cranico":-12},
  "Sportivo": {"Lieve":-1,"Moderato":-3,"Grave":-6},
  "Infortunio sul lavoro": {"Lieve":-2,"Moderato":-6,"Grave":-10},
  "Caduta": {"Lieve":-1,"Moderata":-3,"Grave":-7},
  "Ustione": {"Lieve":-2,"Moderata":-4,"Grave":-8},
  "Intossicazione/Esposizione": {"Lieve":-2,"Moderata":-5,"Grave":-9}
};

/* ===== Droghe (punteggi) ===== */
const DRUGS = {
  "Cannabis":{"Occasionale (&lt;1/mese)":-1,"Mensile":-2,"Settimanale":-3,"Giornaliera":-5},
  "Cocaina":{"Occasionale (&lt;1/mese)":-4,"Mensile":-6,"Settimanale":-10,"Giornaliera":-15},
  "Eroina/oppioidi":{"Occasionale (&lt;1/mese)":-8,"Mensile":-12,"Settimanale":-18,"Giornaliera":-28},
  "Amfetamine":{"Occasionale (&lt;1/mese)":-4,"Mensile":-6,"Settimanale":-10,"Giornaliera":-14},
  "Allucinogeni":{"Occasionale (&lt;1/mese)":-1,"Mensile":-2,"Settimanale":-3,"Giornaliera":-6},
  "Benzodiazepine non prescritte":{"Occasionale (&lt;1/mese)":-3,"Mensile":-5,"Settimanale":-8,"Giornaliera":-12}
};

/* ===== Stato ===== */
const S = { step:1, timeline:[], pastBMI:[], diseases:[], incidents:[], drugs:[], inferred:[], minorWarn:false, childAttempts:0 };

const el = s=>document.querySelector(s);
const els = s=>document.querySelectorAll(s);

/* ===== Init selects ===== */
function fillCountry(sel){ sel.innerHTML = COUNTRIES.map(c=>`<option>${c}</option>`).join(''); }
["residenza","paeseFuturo","paeseTimeline"].forEach(id=>fillCountry(el("#"+id)));
function fillJobs(){
  const sel = el("#lavoroTipo");
  sel.innerHTML = Object.keys(JOBS).map(j=>`<option>${j}</option>`).join('');
}
fillJobs();

/* Diseases/Incidents/Drugs init */
function initDiseaseSelectors(){
  const partSel = el("#bodyPart");
  partSel.innerHTML = Object.keys(DISEASES).map(p=>`<option>${p}</option>`).join('');
  refreshDiseaseCats();
}
function refreshDiseaseCats(){
  const part = el("#bodyPart").value;
  const cats = Object.keys(DISEASES[part]||{});
  el("#diseaseCat").innerHTML = cats.map(c=>`<option>${c}</option>`).join('');
  refreshDiseaseDetails();
}
function refreshDiseaseDetails(){
  const part = el("#bodyPart").value;
  const cat = el("#diseaseCat").value;
  const dets = DISEASES?.[part]?.[cat]||{};
  el("#diseaseDetail").innerHTML = Object.keys(dets).map(d=>`<option>${d}</option>`).join('');
}
initDiseaseSelectors();
el("#bodyPart").addEventListener("change",refreshDiseaseCats);
el("#diseaseCat").addEventListener("change",refreshDiseaseDetails);

function initIncidents(){
  const tSel = el("#incTipo");
  tSel.innerHTML = Object.keys(INCIDENTS).map(k=>`<option>${k}</option>`).join('');
  refreshIncSev();
}
function refreshIncSev(){
  const t = el("#incTipo").value;
  const sev = INCIDENTS[t]||{};
  el("#incSev").innerHTML = Object.keys(sev).map(s=>`<option>${s}</option>`).join('');
}
initIncidents();
el("#incTipo").addEventListener("change",refreshIncSev);

function initDrugs(){
  const dSel = el("#drogaTipo");
  dSel.innerHTML = Object.keys(DRUGS).map(k=>`<option>${k}</option>`).join('');
}
initDrugs();

/* ===== Step/UI ===== */
function showStep(n){
  if(!canProceedToStep(n)) return;
  S.step=n;
  els(".step-panel").forEach(p=>p.hidden=true);
  document.querySelector(`.step-panel[data-step="${n}"]`).hidden=false;
  const pct = ((n-1)/(8-1))*100;
  el("#bar").style.width = pct+"%";
  el("#femaleBox").style.display = el("#sesso").value==="F" ? "" : "none";
  if(n===3) drawBMIChart();
  if(n===7) buildSummary();
}
function next(){ showStep(S.step+1); scrollTopPanel(); }
function back(){ showStep(S.step-1); scrollTopPanel(); }
el("#nextBtn").addEventListener("click", next);
el("#backBtn").addEventListener("click", back);
function scrollTopPanel(){ document.querySelector(`.step-panel[data-step="${S.step}"]`)?.scrollIntoView({behavior:"smooth",block:"start"}); }

el("#trasferFuturo").addEventListener("change", e=>{
  el("#futuroBox").style.display = e.target.value==="si" ? "" : "none";
});
document.addEventListener("keydown",(e)=>{ if(e.key==="Enter") next(); });

/* ===== DOB checks ===== */
function ageFromDOB(dateStr){
  if(!dateStr) return 40;
  const dob = new Date(dateStr), t=new Date();
  let a = t.getFullYear()-dob.getFullYear();
  const m=t.getMonth()-dob.getMonth();
  if(m<0 || (m===0 && t.getDate()<dob.getDate())) a--;
  return Math.max(0,a);
}
function isDOBImprobabile(dateStr){
  if(!dateStr) return false;
  const d=new Date(dateStr); const now=new Date();
  const year=d.getFullYear(), cy=now.getFullYear();
  const age=ageFromDOB(dateStr);
  return (year<1900 || year>cy || age>120);
}
function canProceedToStep(n){
  if(S.step===1 && n>1){
    const dob=el("#dob").value;
    if(!dob){
      if(!confirm("Data di nascita non inserita: continuerò assumendo 40 anni. Va bene?")) return false;
    } else {
      const age = ageFromDOB(dob);
      if(isDOBImprobabile(dob)){
        if(!confirm("La data di nascita sembra improbabile. Vuoi davvero continuare?")) return false;
      }
      if(age<13){
        S.childAttempts++;
        const msg = S.childAttempts<3
          ? "Ehi, sei solo un bambino! Sei sicuro di voler andare avanti?"
          : "Ultimo avviso: questo strumento è pensato per adulti. Procedere comunque?";
        if(!confirm(msg)) return false;
      } else if(age<18 && !S.minorWarn){
        if(!confirm("Avvertenza: questo calcolatore è pensato per adulti. Vuoi continuare?")) return false;
        S.minorWarn=true;
      }
    }
  }
  return true;
}

/* ===== Timeline ===== */
el("#addTimeline").addEventListener("click", ()=>{
  const paese=el("#paeseTimeline").value, dal=+el("#dalAnno").value, al=+el("#alAnno").value;
  if(!paese||!dal||!al||al<dal){ alert("Controlla gli anni."); return; }
  S.timeline.push({paese, dal, al}); renderTimeline();
});
function renderTimeline(){
  const box=el("#timelineList");
  if(S.timeline.length===0){ box.innerHTML=`<div class="card muted">Nessun periodo inserito.</div>`; return; }
  box.innerHTML=S.timeline.map((t,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span class="pill">${t.paese}</span></div>
        <button class="btn ghost small" onclick="rmTL(${i})">Rimuovi</button>
      </div>
      <div class="mini">Dal <strong>${t.dal}</strong> al <strong>${t.al}</strong> — anni: <strong>${t.al - t.dal + 1}</strong> — LE ${LIFE_EXP[t.paese]||"n/d"}</div>
    </div>`).join('');
}
window.rmTL=(i)=>{ S.timeline.splice(i,1); renderTimeline(); };

/* ===== BMI ===== */
el("#calcBMI").addEventListener("click", ()=>{
  const h=+el("#hNow").value, w=+el("#wNow").value;
  if(!h||!w){ alert("Inserisci altezza e peso."); return; }
  const bmi=(w/Math.pow(h/100,2)).toFixed(1);
  const cls = bmi<18.5?"Sottopeso":bmi<25?"Normopeso":bmi<30?"Sovrappeso":"Obesità";
  el("#bmiNowOut").innerHTML=`BMI: <strong>${bmi}</strong> (${cls})`;
  drawBMIChart();
});
el("#addPastBMI").addEventListener("click", ()=>{
  const d=el("#pastDate").value, h=+el("#pastH").value, w=+el("#pastW").value;
  if(!d||!h||!w){ alert("Compila data, altezza e peso."); return; }
  const bmi=+(w/Math.pow(h/100,2)).toFixed(1);
  S.pastBMI.push({data:d,h,w,bmi}); renderPastBMI(); drawBMIChart();
  el("#pastDate").value=""; el("#pastH").value=""; el("#pastW").value="";
});
function renderPastBMI(){
  const box=el("#pastBMIList");
  if(S.pastBMI.length===0){ box.innerHTML=""; return; }
  box.innerHTML=S.pastBMI.map((p,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="pill">${p.data}</div>
        <button class="btn ghost small" onclick="rmPBMI(${i})">Rimuovi</button>
      </div>
      <div class="mini">H: <strong>${p.h} cm</strong> • W: <strong>${p.w} kg</strong> • BMI: <strong>${p.bmi}</strong></div>
    </div>`).join('');
}
window.rmPBMI=(i)=>{ S.pastBMI.splice(i,1); renderPastBMI(); drawBMIChart(); };
function drawBMIChart(){
  const c = el("#bmiChart"); if(!c) return;
  const ctx = c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height);
  const data = S.pastBMI.slice().sort((a,b)=>new Date(a.data)-new Date(b.data));
  const h=+el("#hNow").value||0, w=+el("#wNow").value||0;
  if(h&&w) data.push({data:new Date().toISOString().slice(0,10), bmi:+(w/Math.pow(h/100,2)).toFixed(1)});
  if(data.length<1){ return; }
  const pad=30, W=c.clientWidth||c.width; c.width=W; const H=c.height;
  const xs = data.map(d=>new Date(d.data).getTime());
  const ys = data.map(d=>d.bmi);
  const minX=Math.min(...xs), maxX=Math.max(...xs);
  const minY=Math.min(...ys,18), maxY=Math.max(...ys,32);
  function X(t){ return pad + (W-2*pad)*((t-minX)/(maxX-minX||1)); }
  function Y(v){ return H-pad - (H-2*pad)*((v-minY)/(maxY-minY||1)); }
  // axes
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
  // range lines (normo 18.5-25)
  ctx.setLineDash([4,4]); ctx.strokeStyle = '#22c55e';
  ctx.beginPath(); ctx.moveTo(pad,Y(18.5)); ctx.lineTo(W-pad,Y(18.5)); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad,Y(25)); ctx.lineTo(W-pad,Y(25)); ctx.stroke();
  ctx.setLineDash([]);
  // line
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent'); ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(X(xs[0]), Y(ys[0]));
  for(let i=1;i<data.length;i++){ ctx.lineTo(X(xs[i]), Y(ys[i])); }
  ctx.stroke();
  // points
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent2');
  for(let i=0;i<data.length;i++){ ctx.beginPath(); ctx.arc(X(xs[i]),Y(ys[i]),3,0,Math.PI*2); ctx.fill(); }
}

/* ===== Incidenti ===== */
el("#addInc").addEventListener("click", ()=>{
  const tipo=el("#incTipo").value, sev=el("#incSev").value, anno=el("#incAnno").value||null;
  const score=(INCIDENTS?.[tipo]?.[sev])||0;
  S.incidents.push({tipo,sev,anno,score});
  renderInc();
});
function renderInc(){
  const box=el("#incList");
  if(S.incidents.length===0){ box.innerHTML=`<div class="card muted">Nessun incidente inserito.</div>`; return; }
  box.innerHTML=S.incidents.map((x,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span class="pill">${x.tipo}</span> <span class="chip">${x.sev}</span> ${x.anno?`<span class="mini">(${x.anno})</span>`:""}</div>
        <div class="${x.score<0?'danger':'ok'}"><strong>${x.score}</strong> pts</div>
      </div>
      <button class="btn ghost small" style="margin-top:6px" onclick="rmInc(${i})">Rimuovi</button>
    </div>`).join('');
}
window.rmInc=(i)=>{ S.incidents.splice(i,1); renderInc(); };

/* ===== Patologie ===== */
el("#addDisease").addEventListener("click", ()=>{
  const part=el("#bodyPart").value, cat=el("#diseaseCat").value, det=el("#diseaseDetail").value;
  const score=DISEASES?.[part]?.[cat]?.[det]??0;
  S.diseases.push({part,cat,det,score});
  renderDiseases();
});
function renderDiseases(){
  const box=el("#diseaseList");
  if(S.diseases.length===0){ box.innerHTML = `<div class="card muted">Nessuna patologia inserita.</div>`; return; }
  box.innerHTML=S.diseases.map((d,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
        <div>
          <span class="badge">${d.part}</span>
          <span class="chip">${d.cat}</span>
          <span class="chip">${d.det}</span>
        </div>
        <div class="${d.score<0?'danger':'ok'}"><strong>${d.score}</strong> pts</div>
      </div>
      <button class="btn ghost small" style="margin-top:6px" onclick="rmDis(${i})">Rimuovi</button>
    </div>`).join('');
}
window.rmDis=(i)=>{ S.diseases.splice(i,1); renderDiseases(); };

/* ===== Droghe ===== */
el("#drogheUso").addEventListener("change", e=>{
  const on = e.target.value==="si";
  el("#drogaTipo").disabled = !on;
  el("#drogaFreq").disabled = !on;
});
el("#addDroga").addEventListener("click", ()=>{
  if(el("#drogheUso").value!=="si") return;
  const t=el("#drogaTipo").value, f=el("#drogaFreq").value;
  const score = DRUGS?.[t]?.[f] ?? 0;
  S.drugs.push({tipo:t,freq:f,score});
  renderDrugs();
});
function renderDrugs(){
  const box=el("#drogaList");
  if(S.drugs.length===0){ box.innerHTML=`<div class="card muted">Nessun uso dichiarato.</div>`; return; }
  box.innerHTML=S.drugs.map((d,i)=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span class="pill">${d.tipo}</span> <span class="chip">${d.freq}</span></div>
        <div class="danger"><strong>${d.score}</strong> pts</div>
      </div>
      <button class="btn ghost small" style="margin-top:6px" onclick="rmDrug(${i})">Rimuovi</button>
    </div>`).join('');
}
window.rmDrug=(i)=>{ S.drugs.splice(i,1); renderDrugs(); };

/* ===== Summary ===== */
function buildSummary(){
  S.inferred = [];
  const cards = [];
  const nome = el("#nome").value?.trim()||"(senza nome)";
  const dob = el("#dob").value; const sesso = el("#sesso").value;
  const res = el("#residenza").value; const ambiente = el("#ambiente").value;
  const trasfer = el("#trasferFuturo").value==="si"; const paeseF = el("#paeseFuturo").value; const annoF = +el("#annoFuturo").value||null;
  if(!dob){ S.inferred.push("Data di nascita non inserita: userò età 40 anni di default."); }

  const tl = S.timeline.slice().sort((a,b)=>a.dal-b.dal);
  const sportG = +el("#sportGiorni").value||0, passi = +el("#passi").value||0, sonno = +el("#sonno").value||0;
  const dieta = el("#dieta").value, idr = el("#idratazione").value, alcol = el("#alcol").value;
  const fumoTab = el("#fumoTab").value, sigDie = +el("#sigDie").value||0, anniFumo = +el("#anniFumo").value||0;
  const svapo = el("#svapo").value, svFreq = +el("#svapoFreq").value||0;
  const lavoroTipo=el("#lavoroTipo").value, pasto=el("#pasto").value, reddito=el("#reddito").value;
  const isF = sesso==="F"; const numParti=+el("#numParti").value||0; const tipoParto=el("#tipoParto").value; const compParto=el("#compParto").value;
  const stress=+el("#stress").value||0; const stressTrig=Array.from(el("#stressTrig").selectedOptions).map(o=>o.value);
  const hNow=+el("#hNow").value||0, wNow=+el("#wNow").value||0; const bmiNow = hNow&&wNow ? +(wNow/Math.pow(hNow/100,2)).toFixed(1) : null;

  cards.push(`
    <div class="card">
      <div class="mini"><strong>Anagrafica</strong></div>
      <ul class="list">
        <li>Nome: <strong>${nome}</strong> • Nascita: <strong>${dob||"n/d"}</strong> • Sesso: <strong>${sesso}</strong></li>
        <li>Residenza: <strong>${res}</strong> • Ambiente: <strong>${ambiente}</strong></li>
        <li>Trasferimento futuro: <strong>${trasfer?("Sì → "+paeseF+" "+(annoF||"n/d")):"No"}</strong></li>
      </ul>
    </div>`);
  const tlRows = tl.map(t=>`<tr><td>${t.paese}</td><td>${t.dal}</td><td>${t.al}</td><td>${t.al - t.dal + 1}</td><td>${LIFE_EXP[t.paese]||"n/d"}</td></tr>`).join('');
  cards.push(`
    <div class="card">
      <div class="mini"><strong>Timeline Paesi</strong></div>
      <table class="table"><thead><tr><th>Paese</th><th>Dal</th><th>Al</th><th>Anni</th><th>LE</th></tr></thead><tbody>${tlRows||`<tr><td colspan="5" class="muted">Nessun periodo</td></tr>`}</tbody></table>
    </div>`);
  cards.push(`
    <div class="card">
      <div class="mini"><strong>Stile di vita</strong></div>
      <ul class="list">
        <li>Sport: <strong>${sportG}</strong>/set • Passi: <strong>${passi}</strong>/die • Sonno: <strong>${sonno}</strong> h</li>
        <li>Dieta: <strong>${dieta}</strong> • Idratazione: <strong>${idr}</strong> • Alcol: <strong>${alcol}</strong></li>
        <li>Fumo: <strong>${fumoTab}</strong> ${sigDie?`• ${sigDie} cig/die`:''} ${anniFumo?`• ${anniFumo} anni`:''} • Svapo: <strong>${svapo}</strong> ${svFreq?`(${svFreq}/g)`:''}</li>
        <li>BMI: <strong>${bmiNow??"n/d"}</strong></li>
      </ul>
    </div>`);
  cards.push(`
    <div class="card">
      <div class="mini"><strong>Lavoro & Reddito</strong></div>
      <ul class="list">
        <li>Lavoro: <strong>${lavoroTipo}</strong> • Pasti: <strong>${pasto}</strong> • Reddito: <strong>${reddito}</strong></li>
      </ul>
    </div>`);
  cards.push(`
    <div class="card">
      <div class="mini"><strong>Incidenti</strong></div>
      <div>${S.incidents.length? S.incidents.map(i=>`<span class="chip">${i.tipo} • ${i.sev}${i.anno?` • ${i.anno}`:''}</span>`).join(' ') : `<span class="muted">Nessuno</span>`}</div>
    </div>`);
  cards.push(`
    <div class="card">
      <div class="mini"><strong>Patologie</strong></div>
      <div>${S.diseases.length? S.diseases.map(d=>`<span class="chip">${d.part} • ${d.cat} • ${d.det}</span>`).join(' ') : `<span class="muted">Nessuna</span>`}</div>
    </div>`);
  cards.push(`
    <div class="card">
      <div class="mini"><strong>Stress & Droghe</strong></div>
      <ul class="list">
        <li>Stress: <strong>${stress}/10</strong> ${stressTrig.length?`• Trigger: ${stressTrig.join(", ")}`:""}</li>
        <li>Droghe: ${S.drugs.length? S.drugs.map(d=>`<span class="chip">${d.tipo} • ${d.freq}</span>`).join(' ') : `<span class="muted">Nessun uso dichiarato</span>`}</li>
      </ul>
    </div>`);
  if(isF){
    cards.push(`
      <div class="card">
        <div class="mini"><strong>Parti</strong></div>
        <ul class="list">
          <li>Numero: <strong>${numParti}</strong> • Tipo prevalente: <strong>${tipoParto}</strong> • Complicazioni: <strong>${compParto}</strong></li>
        </ul>
      </div>`);
  }
  if(S.inferred.length){
    cards.push(`<div class="card"><div class="mini"><strong>Inferenze</strong></div><ul class="list">${S.inferred.map(x=>`<li>${x}</li>`).join('')}</ul></div>`);
  }
  el("#summaryCards").innerHTML = cards.join('');
}

/* ===== Calcolo ===== */
function baselineFromCountries(){
  let totalY=0,sum=0;
  S.timeline.forEach(t=>{ const y=(t.al-t.dal+1); const le=LIFE_EXP[t.paese]||78; sum+=le*y; totalY+=y; });
  if(totalY===0){ return LIFE_EXP[el("#residenza").value]||78; }
  return sum/totalY;
}
function envAdj(env){ return env==="mare"?0.6:env==="montagna"?0.4:env==="campagna"?0.3:0; }
function lifestyleScoreYears(){
  const sportG=+el("#sportGiorni").value||0, passi=+el("#passi").value||0, sonno=+el("#sonno").value||0;
  const dieta=el("#dieta").value, idr=el("#idratazione").value, alcol=el("#alcol").value;
  const hNow=+el("#hNow").value||0, wNow=+el("#wNow").value||0;
  let pts=0;
  pts += Math.min(10, sportG*2);
  if(passi>=9000) pts+=8; else if(passi>=7000) pts+=5; else if(passi>=5000) pts+=2; else pts-=3;
  if(sonno>=7 && sonno<=9) pts+=5; else if(sonno<6) pts-=5; else if(sonno>10) pts-=2;
  if(dieta==="sana") pts+=8; else if(dieta==="scorretta") pts-=8;
  if(idr==="acqua") pts+=4; else if(idr==="zuccherate") pts-=6;
  if(alcol==="alto") pts-=8; else if(alcol==="moderato") pts-=2;
  if(hNow&&wNow){
    const bmi=wNow/Math.pow(hNow/100,2);
    if(bmi<18.5) pts-=4; else if(bmi<25) pts+=6; else if(bmi<30) pts-=4; else pts-=10;
  }
  pts = Math.max(-30,Math.min(30,pts));
  return pts*0.3;
}
function smokingYears(){
  const fumoTab=el("#fumoTab").value, sigDie=+el("#sigDie").value||0, anniFumo=+el("#anniFumo").value||0;
  const svapo=el("#svapo").value, svFreq=+el("#svapoFreq").value||0;
  let y=0;
  if(fumoTab!=="no"){
    const packYears = (sigDie/20)*anniFumo;
    y += -Math.min(12, packYears*0.5);
    if(fumoTab==="sigari"||fumoTab==="pipa") y += -1.5;
  }
  if(svapo!=="no"){
    if(svapo==="siNic") y += -Math.min(4, svFreq*0.01 + 1.0);
    else y += -Math.min(2, svFreq*0.005 + 0.4);
  }
  return y;
}
function workYears(){ const job=JOBS[el("#lavoroTipo").value]; return job? (job.years||0):0; }
function incomeYears(){
  const r=el("#reddito").value;
  if(r==="basso") return -1.0;
  if(r==="medio-basso") return -0.4;
  if(r==="medio") return 0.2;
  if(r==="alto") return 0.6;
  if(r==="molto-alto") return 0.8;
  return 0;
}
function mealYears(){ return el("#pasto").value==="fretta" ? -0.3 : 0.2; }
function diseaseYears(){ const sum=S.diseases.reduce((a,d)=>a+(d.score||0),0); return Math.max(-70,sum)*0.6; }
function incidentsYears(){ const sum=S.incidents.reduce((a,i)=>a+(i.score||0),0); return Math.max(-35,sum)*0.5; }
function drugsYears(){ const sum=S.drugs.reduce((a,d)=>a+(d.score||0),0); return Math.max(-40,sum)*0.6; }
function femaleBirthYears(){
  if(el("#sesso").value!=="F") return 0;
  const n=+el("#numParti").value||0, tipo=el("#tipoParto").value, comp=el("#compParto").value;
  let y = 0;
  if(n>0){
    y += Math.min(1.0, n*0.15);
    if(tipo==="cesareo") y -= Math.min(0.8, n*0.1);
    if(comp==="lievi") y -= 0.2;
    if(comp==="gravi") y -= 1.0;
  }
  return y;
}
function stressYears(){ const s=+el("#stress").value||0; return -(s*0.15); }
function futureAdj(){
  if(el("#trasferFuturo").value!=="si") return 0;
  const paese = el("#paeseFuturo").value;
  const target = LIFE_EXP[paese] || 78;
  const base = baselineFromCountries();
  const delta = target - base;
  return delta * 0.2;
}
function sexYears(){ const sx=el("#sesso").value; if(sx==="F") return +1.8; if(sx==="M") return 0; return +0.5; }
function cohortYears(){ const a=ageFromDOB(el("#dob").value); if(a<40) return 1.5; if(a<=60) return 0.6; return 0.2; }

function computeExpectedAge(){
  const base=baselineFromCountries();
  const env=envAdj(el("#ambiente").value);
  const life=lifestyleScoreYears();
  const smoke=smokingYears();
  const job=workYears();
  const income=incomeYears();
  const meal=mealYears();
  const dis=diseaseYears();
  const inc=incidentsYears();
  const drug=drugsYears();
  const fem=femaleBirthYears();
  const stress=stressYears();
  const fut=futureAdj();
  const sex=sexYears();
  const coh=cohortYears();

  let expected = base + env + life + smoke + job + income + meal + dis + inc + drug + fem + stress + fut + sex + coh;
  expected = Math.max(50, Math.min(108, expected));

  const health = Math.max(-100, Math.min(100,
    (life/0.3)*2 + (dis/0.6)*1.2 + (inc/0.5)*0.8 + (smoke)*3 + (drug/0.6)*1.2 - (stress*8) + (income*10)
  ));
  return {expected, health, comp:{base,env,life,smoke,job,income,meal,dis,inc,drug,fem,stress,fut,sex,coh}};
}

function milestoneProbs(expected, currentAge){
  const spread = 9; const ages=[70,80,90,100,110]; const probs={};
  ages.forEach(a=>{ const p=1/(1+Math.exp((a-expected)/spread)); probs[a]=currentAge>=a?1:p; });
  return probs;
}
function fmtPct(x){ return Math.round(x*100); }

function compute(){
  const {expected, health, comp} = computeExpectedAge();
  const name = el("#nome").value?.trim()||"Tu";
  const age = ageFromDOB(el("#dob").value);
  const today=new Date();
  const yrs = expected - age;
  const date = new Date(today.getFullYear()+Math.round(Math.max(0,yrs)), today.getMonth(), today.getDate());

  // Frase simpatica se expected < age
  let extraDaysMsg = "";
  if(expected < age){
    const extraYears = age - expected;
    const extraDays = Math.round(extraYears * 365.25);
    extraDaysMsg = ` — 👏 Hai già vissuto <strong>${extraDays}</strong> giorni in più rispetto alla media prevista!`;
  }

  el("#resultHead").innerHTML = `${name}, stima ludica: ${expected.toFixed(1)} anni${extraDaysMsg}`;
  el("#etaStimata").textContent = `${expected.toFixed(1)} anni`;
  el("#saluteScore").textContent = `${Math.round(health)}`;
  el("#resultDate").innerHTML = `Data indicativa (non reale): <strong>${date.toLocaleDateString("it-IT")}</strong> — anni residui ~ <strong>${Math.max(0,yrs).toFixed(1)}</strong>`;

  const probs = milestoneProbs(expected, age);
  el("#milestones").innerHTML = [70,80,90,100,110].map(a=>{
    const p=probs[a]; const cls=p>=0.7?'ok':p>=0.4?'warn':'danger';
    return `<tr><td>${a} anni</td><td><span class="${cls}"><strong>${fmtPct(p)}%</strong></span></td></tr>`;
  }).join('');

  const drivers=[];
  drivers.push(`Base Paesi/Residenza: <strong>${comp.base.toFixed(1)}</strong> anni`);
  if(comp.env) drivers.push(`Ambiente: ${comp.env>0?'+':''}${comp.env.toFixed(1)} anni`);
  if(comp.life) drivers.push(`Stile di vita: ${comp.life>0?'+':''}${comp.life.toFixed(1)} anni`);
  if(comp.smoke) drivers.push(`Fumo/svapo: ${comp.smoke.toFixed(1)} anni`);
  if(comp.job) drivers.push(`Lavoro: ${comp.job.toFixed(1)} anni`);
  if(comp.income) drivers.push(`Reddito: ${comp.income>0?'+':''}${comp.income.toFixed(1)} anni`);
  if(comp.meal) drivers.push(`Ritmo pasti: ${comp.meal>0?'+':''}${comp.meal.toFixed(1)} anni`);
  if(comp.dis) drivers.push(`Patologie: ${comp.dis.toFixed(1)} anni`);
  if(comp.inc) drivers.push(`Incidenti: ${comp.inc.toFixed(1)} anni`);
  if(comp.drug) drivers.push(`Droghe: ${comp.drug.toFixed(1)} anni`);
  if(comp.fem) drivers.push(`Parti/complicazioni: ${comp.fem>0?'+':''}${comp.fem.toFixed(1)} anni`);
  if(comp.stress) drivers.push(`Stress: ${comp.stress.toFixed(1)} anni`);
  if(comp.fut) drivers.push(`Trasferim. futuro: ${comp.fut>0?'+':''}${comp.fut.toFixed(1)} anni`);
  if(comp.sex) drivers.push(`Sesso: ${comp.sex>0?'+':''}${comp.sex.toFixed(1)} anni`);
  if(comp.coh) drivers.push(`Coorte/progresso: +${comp.coh.toFixed(1)} anni`);
  el("#drivers").innerHTML = drivers.map(d=>`<li>${d}</li>`).join('');

  // Consigli
  const tips=[]; const passi=+el("#passi").value||0; if(passi<7000) tips.push("Porta gradualmente i passi a 7–9k/die.");
  const sonno=+el("#sonno").value||0; if(sonno<7||sonno>9) tips.push("Punta a 7–9 ore di sonno regolari.");
  const idr=el("#idratazione").value; if(idr!=="acqua") tips.push("Riduci le bevande zuccherate a favore di acqua/infusi.");
  const alcol=el("#alcol").value; if(alcol!=="no") tips.push("Contieni l’alcol (o periodi ‘dry’).");
  const fumoTab=el("#fumoTab").value; if(fumoTab!=="no") tips.push("Avvia un percorso per smettere di fumare (supporto medico/app).");
  const svapo=el("#svapo").value; if(svapo!=="no") tips.push("Riduci frequenza e nicotina fino a stop.");
  const h=+el("#hNow").value||0, w=+el("#wNow").value||0; if(h&&w){ const bmi=w/Math.pow(h/100,2); if(bmi>=25) tips.push("Deficit calorico leggero e più movimento per riportare il BMI tra 20–25."); }
  const job = JOBS[el("#lavoroTipo").value]; if(job?.expo?.dust||job?.expo?.silica) tips.push("Usa DPI (FFP3) e monitoraggi periodici per polveri/silice.");
  if(job?.expo?.chem) tips.push("Ventilazione/aspirazione e DPI per solventi/vernici.");
  if(job?.expo?.night) tips.push("Igiene circadiana per i turni (luce diurna, blocco blu la sera).");
  const stressV=+el("#stress").value||0; if(stressV>=5) tips.push("Protocollo anti-stress: 10’ respiro 4-6, 20’ camminata, journaling serale.");
  if(S.drugs.length) tips.push("Se usi sostanze: valuta un consulto riservato per riduzione del danno.");
  if(tips.length===0) tips.push("Ottimo profilo! Mantieni le abitudini e prevenzione periodica.");
  el("#tips").innerHTML = tips.map(t=>`<li>${t}</li>`).join('');

  // Stima anni guadagnabili (best-case modificabile)
  const ideal = simulateIdealExpected();
  const gain = Math.max(0, ideal - expected);
  el("#potentialGain").innerHTML = `<strong>Potenziale miglioramento:</strong> applicando i consigli potresti guadagnare fino a <strong>+${gain.toFixed(1)} anni</strong> (stima).`;

  showStep(8);
}

/* Best-case: simula abitudini ottimali (non tocca malattie/incidenti passati) */
function simulateIdealExpected(){
  // Salva valori correnti
  const backup = {
    sport:+el("#sportGiorni").value, passi:+el("#passi").value, sonno:+el("#sonno").value,
    dieta:el("#dieta").value, idr:el("#idratazione").value, alcol:el("#alcol").value,
    fumo:el("#fumoTab").value, sigDie:+el("#sigDie").value, anniF:+el("#anniFumo").value,
    svapo:el("#svapo").value, svFreq:+el("#svapoFreq").value,
    pasto:el("#pasto").value, reddito:el("#reddito").value, lavoro:el("#lavoroTipo").value,
    stress:+el("#stress").value
  };
  // Set ideali raggiungibili
  el("#sportGiorni").value=4;
  el("#passi").value=9000;
  el("#sonno").value=8;
  el("#dieta").value="sana";
  el("#idratazione").value="acqua";
  el("#alcol").value="no";
  el("#fumoTab").value="no"; el("#sigDie").value=0; el("#anniFumo").value=0;
  el("#svapo").value="no"; el("#svapoFreq").value=0;
  el("#pasto").value="calma";
  // Reddito: se basso → miglioramento (proxy)
  if(backup.reddito==="basso"||backup.reddito==="medio-basso") el("#reddito").value="medio";
  // Lavoro: non lo cambiamo, ma l'ideale riduce impatti non modificabili (lasciamo invariato)
  // Stress: abbassiamo
  el("#stress").value = Math.max(2, backup.stress-3);
  // BMI: non lo forziamo qui (già incluso via dieta/sport/sonno); se vuoi, potresti simulare BMI 22.5 riducendo peso.

  const {expected} = computeExpectedAge();

  // Ripristina
  el("#sportGiorni").value=backup.sport; el("#passi").value=backup.passi; el("#sonno").value=backup.sonno;
  el("#dieta").value=backup.dieta; el("#idratazione").value=backup.idr; el("#alcol").value=backup.alcol;
  el("#fumoTab").value=backup.fumo; el("#sigDie").value=backup.sigDie; el("#anniFumo").value=backup.anniF;
  el("#svapo").value=backup.svapo; el("#svapoFreq").value=backup.svFreq;
  el("#pasto").value=backup.pasto; el("#reddito").value=backup.reddito; el("#lavoroTipo").value=backup.lavoro;
  el("#stress").value=backup.stress;
  return expected;
}

/* ===== Report export (stampa/HTML) ===== */
document.getElementById("exportReport").addEventListener("click", ()=>{
  const reportHTML = generateReportHTML();
  const w=window.open(""); w.document.write(reportHTML); w.document.close();
  setTimeout(()=>w.print(), 300);
});
function generateReportHTML(){
  const name = el("#nome").value?.trim()||"Tu";
  return `
<!DOCTYPE html><html><head><meta charset="utf-8"><title>Report longevità</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;padding:20px;color:#111}
  h1{margin:0 0 6px;font-size:22px} h2{margin:18px 0 6px;font-size:18px}
  table{width:100%;border-collapse:collapse;margin:8px 0} th,td{border:1px solid #ddd;padding:6px;text-align:left}
  .muted{color:#555} .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin:2px;font-size:12px}
  .kpi{display:inline-block;min-width:200px;border:1px solid #ddd;padding:10px;border-radius:10px;margin:4px 8px 4px 0}
  @media print{.noprint{display:none}}
</style></head><body>
<h1>Report longevità — ${name}</h1>
<div class="muted">Generato: ${new Date().toLocaleString("it-IT")}</div>

<h2>Risultato</h2>
<div>${el("#resultHead").innerHTML}</div>
<div class="kpi"><strong>Età stimata</strong><div>${el("#etaStimata").textContent}</div></div>
<div class="kpi"><strong>Indice salute</strong><div>${el("#saluteScore").textContent}</div></div>
<div style="margin:8px 0">${el("#resultDate").innerHTML}</div>

<h2>Probabilità traguardi</h2>
<table>${el("#milestones").parentElement.parentElement.innerHTML}</table>

<h2>Fattori principali</h2>
<ul>${el("#drivers").innerHTML}</ul>

<h2>Consigli</h2>
<ul>${el("#tips").innerHTML}</ul>
<div>${el("#potentialGain").innerHTML}</div>

<h2>Dati inseriti (riepilogo)</h2>
<div>${el("#summaryCards").innerHTML}</div>

<hr>
<div class="muted">Creata da <strong>Stephan Winckler</strong> per divertimento. Non è un consiglio medico.</div>
</body></html>`;
}

/* ===== Export/Import JSON ===== */
document.getElementById("exportJSON").addEventListener("click", ()=>{
  const data = collectAllData();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='longevita_data.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById("importJSON").addEventListener("change", async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const text=await file.text(); const data=JSON.parse(text);
  applyAllData(data);
  alert("Dati importati.");
});
function collectAllData(){
  return {
    nome:el("#nome").value, dob:el("#dob").value, sesso:el("#sesso").value,
    residenza:el("#residenza").value, ambiente:el("#ambiente").value,
    trasferFuturo:el("#trasferFuturo").value, paeseFuturo:el("#paeseFuturo").value, annoFuturo:el("#annoFuturo").value,
    timeline:S.timeline, sportGiorni:el("#sportGiorni").value, passi:el("#passi").value, sonno:el("#sonno").value,
    dieta:el("#dieta").value, idratazione:el("#idratazione").value, alcol:el("#alcol").value,
    fumoTab:el("#fumoTab").value, sigDie:el("#sigDie").value, anniFumo:el("#anniFumo").value,
    svapo:el("#svapo").value, svapoFreq:el("#svapoFreq").value,
    hNow:el("#hNow").value, wNow:el("#wNow").value, pastBMI:S.pastBMI,
    lavoroTipo:el("#lavoroTipo").value, pasto:el("#pasto").value, reddito:el("#reddito").value,
    incidents:S.incidents, diseases:S.diseases,
    numParti:el("#numParti").value, tipoParto:el("#tipoParto").value, compParto:el("#compParto").value,
    stress:el("#stress").value, stressTrig:Array.from(el("#stressTrig").selectedOptions).map(o=>o.value),
    drugs:S.drugs
  };
}
function applyAllData(d){
  el("#nome").value=d.nome||""; el("#dob").value=d.dob||""; el("#sesso").value=d.sesso||"nd";
  el("#residenza").value=d.residenza||COUNTRIES[0]; el("#ambiente").value=d.ambiente||"citta";
  el("#trasferFuturo").value=d.trasferFuturo||"no"; el("#paeseFuturo").value=d.paeseFuturo||COUNTRIES[0]; el("#annoFuturo").value=d.annoFuturo||"";
  S.timeline=d.timeline||[]; renderTimeline();
  el("#sportGiorni").value=d.sportGiorni||0; el("#passi").value=d.passi||0; el("#sonno").value=d.sonno||0;
  el("#dieta").value=d.dieta||"mista"; el("#idratazione").value=d.idratazione||"mista"; el("#alcol").value=d.alcol||"moderato";
  el("#fumoTab").value=d.fumoTab||"no"; el("#sigDie").value=d.sigDie||0; el("#anniFumo").value=d.anniFumo||0;
  el("#svapo").value=d.svapo||"no"; el("#svapoFreq").value=d.svapoFreq||0;
  el("#hNow").value=d.hNow||""; el("#wNow").value=d.wNow||""; S.pastBMI=d.pastBMI||[]; renderPastBMI(); drawBMIChart();
  el("#lavoroTipo").value=d.lavoroTipo||Object.keys(JOBS)[0]; el("#pasto").value=d.pasto||"calma"; el("#reddito").value=d.reddito||"medio";
  S.incidents=d.incidents||[]; renderInc(); S.diseases=d.diseases||[]; renderDiseases();
  el("#numParti").value=d.numParti||0; el("#tipoParto").value=d.tipoParto||"nessuno"; el("#compParto").value=d.compParto||"no";
  el("#stress").value=d.stress||0;
  Array.from(el("#stressTrig").options).forEach(opt=>{ opt.selected = (d.stressTrig||[]).includes(opt.value); });
  S.drugs=d.drugs||[]; renderDrugs();
}

/* ===== Nav + footer year ===== */
function renderSteps(){ const pct=((S.step-1)/(8-1))*100; el("#bar").style.width=pct+"%"; }
document.getElementById("year").textContent = new Date().getFullYear();

/* ===== Hook calcolo e ricomincia ===== */
el("#doCalc").addEventListener("click", compute);
el("#ricomincia").addEventListener("click", ()=>location.reload());

/* ===== Start ===== */
initDiseaseSelectors(); initIncidents(); initDrugs();
renderSteps(); showStep(1);

/* ===== Fill country selects (after DOM ready) ===== */
function fillCountrySelect(id){ const s=el("#"+id); s.innerHTML=COUNTRIES.map(c=>`<option>${c}</option>`).join(''); }
["residenza","paeseFuturo","paeseTimeline"].forEach(fillCountrySelect);
</script>
</body>
</html>